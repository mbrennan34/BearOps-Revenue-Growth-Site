<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery & Persona Messaging Workspace - BearOps</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0A1628 0%, #1a2942 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.08);
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-nav {
            text-align: center;
            margin-bottom: 20px;
        }

        .lead-link-gradient {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .lead-link-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Tab switcher */
        .tab-switcher {
            display: inline-flex;
            margin: 10px auto 20px;
            padding: 4px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .tab-btn {
            border: none;
            background: transparent;
            color: #cbd5f5;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
        }

        .tab-content {
            display: none;
            margin-top: 10px;
        }

        .tab-content.active {
            display: block;
        }

        .info-panel {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            padding: 18px 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .info-panel h2 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: #e5e7eb;
        }

        .info-panel p {
            font-size: 0.9rem;
            color: #cbd5f5;
            margin-bottom: 8px;
        }

        .info-panel ul {
            margin-left: 18px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: #cbd5f5;
        }

        .info-panel li {
            margin-bottom: 2px;
        }

        .controls-bar {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 16px;
            padding: 18px 20px;
            margin-bottom: 18px;
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
            gap: 16px;
            align-items: flex-start;
        }

        .trigger-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trigger-selector-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .trigger-selector label {
            font-weight: 600;
            color: #667eea;
            white-space: nowrap;
        }

        .trigger-selector select {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .trigger-selector select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.15);
        }

        .trigger-selector select option {
            background: #1a2942;
            color: white;
        }

        .trigger-help {
            font-size: 0.8rem;
            color: rgba(226, 232, 255, 0.7);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-new {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-delete {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.25);
            color: #e5e7eb;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.4);
        }

        .save-indicator {
            text-align: right;
            margin-top: 10px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .trigger-summary {
            margin-bottom: 20px;
            padding: 16px 18px;
            background: rgba(30, 64, 175, 0.24);
            border-radius: 14px;
            border-left: 4px solid #667eea;
        }

        .trigger-summary-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .trigger-summary-body {
            font-size: 0.85rem;
            color: #cbd5f5;
        }

        .discovery-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 18px;
            margin-top: 10px;
        }

        .discovery-card {
            background: rgba(15, 23, 42, 0.96);
            border-radius: 16px;
            padding: 16px 18px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.8);
        }

        .discovery-header {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
        }

        .discovery-number {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: linear-gradient(135deg, #667eea 0%, #22c55e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .discovery-title h3 {
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .discovery-title p {
            font-size: 0.8rem;
            color: rgba(226, 232, 255, 0.8);
        }

        .step-meta {
            font-size: 0.75rem;
            color: #a5b4fc;
            margin-top: 2px;
        }

        .discovery-content label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #bbf7d0;
        }

        .discovery-content textarea,
        .custom-questions textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px 10px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            color: #e5e7eb;
            font-size: 0.85rem;
            resize: vertical;
        }

        .questions-section {
            margin-top: 10px;
        }

        .questions-section h4 {
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .core-questions {
            margin-bottom: 8px;
        }

        .core-questions-label {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .core-questions-body {
            font-size: 0.8rem;
            line-height: 1.4;
            padding: 8px 10px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 8px;
            border: 1px dashed rgba(148, 163, 184, 0.7);
            white-space: pre-line;
        }

        .custom-questions-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #bbf7d0;
            margin-bottom: 4px;
        }

        .example-box {
            margin-top: 8px;
            border-top: 1px dashed rgba(148, 163, 184, 0.6);
            padding-top: 8px;
        }

        .example-toggle {
            border: none;
            background: transparent;
            color: #a5b4fc;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0;
            margin-bottom: 4px;
        }

        .example-content {
            font-size: 0.78rem;
            color: rgba(226, 232, 255, 0.8);
            white-space: pre-line;
        }

        .example-content.collapsed {
            display: none;
        }

        /* --- NEW: Personalization matrix panel --- */

        .personalization-panel {
            margin: 16px 0 18px;
            padding: 16px 18px 12px;
            background: rgba(15, 23, 42, 0.96);
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            box-shadow: 0 14px 36px rgba(15, 23, 42, 0.9);
        }

        .personalization-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .personalization-header h3 {
            font-size: 1.05rem;
            margin-bottom: 2px;
        }

        .personalization-header p {
            font-size: 0.8rem;
            max-width: 700px;
            color: rgba(226, 232, 255, 0.8);
        }

        .personalization-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.75rem;
            color: #e5e7eb;
            margin-bottom: 10px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
        }

        .legend-dot.most {
            background: #ef4444;
        }

        .legend-dot.moderate {
            background: #facc15;
        }

        .legend-dot.least {
            background: #1d4ed8;
        }

        .personalization-columns {
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr));
            gap: 10px;
            overflow-x: auto;
        }

        .personalization-column {
            background: radial-gradient(circle at top, rgba(148, 163, 184, 0.3), rgba(15, 23, 42, 0.95));
            border-radius: 14px;
            padding: 10px 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            min-width: 180px;
        }

        .personalization-column h4 {
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 8px;
        }

        .personalization-pill {
            width: 100%;
            border-radius: 999px;
            border: none;
            padding: 6px 10px;
            margin-bottom: 6px;
            font-size: 0.78rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
            color: #111827;
            text-align: center;
            white-space: normal;
        }

        .personalization-pill.pill-most {
            background: #ef4444;
            color: #fee2e2;
        }

        .personalization-pill.pill-moderate {
            background: #facc15;
            color: #1f2933;
        }

        .personalization-pill.pill-least {
            background: #1d4ed8;
            color: #e5e7eb;
        }

        .personalization-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.7);
            filter: brightness(1.05);
        }

        .personalization-pill.active {
            outline: 2px solid #22c55e;
            outline-offset: 1px;
            box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.7);
        }

        .personalization-tip {
            margin-top: 10px;
            font-size: 0.78rem;
            color: #cbd5f5;
            padding-top: 8px;
            border-top: 1px dashed rgba(148, 163, 184, 0.6);
        }

        .personalization-tip strong {
            color: #e5e7eb;
        }

        /* Modals */

        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .modal-content {
            max-width: 600px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1a2942 0%, #0A1628 100%);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .modal-header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #48bb78;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Messaging Library */

        .messaging-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 2fr);
            gap: 20px;
        }

        .messaging-filters-card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 18px 20px 20px;
            height: fit-content;
        }

        .messaging-filters-card h3 {
            font-size: 1.05rem;
            margin-bottom: 6px;
            color: #e5e7eb;
        }

        .messaging-filters-card p {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 14px;
        }

        .persona-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .persona-chip {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.8);
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            font-size: 0.8rem;
            padding: 4px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .persona-chip:hover {
            background: rgba(99, 102, 241, 0.3);
            border-color: #6366f1;
        }

        .persona-chip.active {
            background: #6366f1;
            color: #e5e7eb;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 10px;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .messaging-filters-card select {
            width: 100%;
            padding: 8px 10px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.7);
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 0.9rem;
        }

        .messaging-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .messaging-results {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 18px 20px 20px;
        }

        .messaging-results-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .messaging-results-header h3 {
            font-size: 1.05rem;
        }

        .results-meta {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .sequence-toggle {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .message-card {
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 10px 12px;
            margin-bottom: 10px;
            background: rgba(15, 23, 42, 0.95);
            cursor: pointer;
        }

        .message-card-header {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .message-main-info h4 {
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .message-meta {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .tag {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            padding: 2px 8px;
            font-size: 0.7rem;
        }

        .tag.trigger {
            border-color: #6366f1;
            color: #c7d2fe;
        }

        .tag.persona {
            border-color: #22c55e;
            color: #bbf7d0;
        }

        .message-channel {
            font-size: 0.8rem;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .message-subject {
            font-size: 0.85rem;
            color: #e5e7eb;
        }

        .message-body {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed rgba(148, 163, 184, 0.5);
            font-size: 0.85rem;
            color: #e5e7eb;
            white-space: pre-line;
            display: none;
        }

        .message-card.expanded .message-body {
            display: block;
        }

        .message-card.expanded {
            border-color: #22c55e;
        }

        .message-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-ghost {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            background: transparent;
            color: #e5e7eb;
            font-size: 0.75rem;
            padding: 4px 10px;
            cursor: pointer;
        }

        .btn-ghost:hover {
            background: rgba(148, 163, 184, 0.25);
        }

        .btn-ghost-danger {
            border-color: #f97373;
            color: #fecaca;
        }

        .btn-ghost-danger:hover {
            background: rgba(248, 113, 113, 0.25);
        }

        .no-results {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-top: 12px;
        }

        /* Call prospecting embed */
        .call-iframe-wrapper {
            margin-top: 20px;
        }

        .call-iframe {
            width: 100%;
            min-height: 1200px;
            border-radius: 18px;
            border: 2px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
        }

        /* ===== AI ENHANCEMENT STYLES ===== */
        .ai-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.5);
        }

        .ai-btn:active {
            transform: translateY(0);
        }

        .ai-btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .ai-prompt-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 10000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }

        .ai-prompt-content {
            max-width: 900px;
            margin: 50px auto;
            background: linear-gradient(135deg, #0A1628 0%, #1a2942 100%);
            border-radius: 16px;
            padding: 30px;
            border: 2px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .ai-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(168, 85, 247, 0.2);
        }

        .ai-prompt-header h3 {
            color: #c084fc;
            font-size: 1.5em;
            margin: 0;
        }

        .ai-prompt-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .ai-prompt-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ai-prompt-box {
            background: rgba(15, 23, 42, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            margin-bottom: 20px;
            position: relative;
        }

        .ai-prompt-box h4 {
            color: #a78bfa;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .ai-prompt-box pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            color: #e0e7ff;
            font-size: 0.9em;
            line-height: 1.6;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .copy-prompt-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #6366f1;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .copy-prompt-btn:hover {
            background: #4f46e5;
        }

        .ai-usage-tip {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #fbbf24;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .discovery-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .discovery-card-header h3 {
            margin: 0;
        }

        @media print {
            .controls-bar,
            .top-nav,
            .btn,
            .info-panel,
            img,
            .tab-switcher,
            #tab-messaging,
            #tab-call-prospecting,
            .ai-btn,
            .ai-prompt-modal {
                display: none !important;
            }

            body {
                background: white;
                color: #000;
            }

            .discovery-card {
                box-shadow: none;
                border-radius: 0;
                border: 1px solid #ccc;
            }
        }

        @media (max-width: 1100px) {
            .discovery-grid {
                grid-template-columns: 1fr;
            }
            .personalization-columns {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        @media (max-width: 900px) {
            .messaging-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 12px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                justify-content: stretch;
                flex-wrap: wrap;
            }

            .btn {
                flex: 1;
            }

            .personalization-columns {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Overlaid logo (doesn't change layout) -->
    <img src="../assets/images/BearOps_Logo_Default.png" alt="BearOps Logo">

    <div class="container">
        <div class="top-nav">
            <a href="sales-engine-architecture.html" class="lead-link-gradient">Sales Engine</a>
           
        </div>

        <div class="header">
            <div class="logo">Discovery & Persona Messaging Workspace</div>
            <div class="tab-switcher">
                <button class="tab-btn active" data-tab="discovery">Discovery Builder</button>
                <button class="tab-btn" data-tab="messaging">Messaging Library</button>
                <button class="tab-btn" data-tab="call-prospecting">Call Prospecting</button>
            </div>
        </div>

        <!-- TAB: DISCOVERY BUILDER -->
        <div id="tab-discovery" class="tab-content active">
            <div class="info-panel">
                <h2>Discovery Builder (Persona â†’ Trigger)</h2>
                <p>
                    Start with a <strong>Persona</strong>, then select the relevant <strong>Sales Trigger</strong> for that persona.
                    Each persona+trigger combination has its own 6-step discovery flow:
                </p>
                <ul>
                    <li><strong>Current State</strong></li>
                    <li><strong>Problems & Pain Points</strong></li>
                    <li><strong>Business Impact</strong></li>
                    <li><strong>Root Cause Analysis</strong></li>
                    <li><strong>Decision Criteria</strong></li>
                    <li><strong>Required Outcomes</strong></li>
                </ul>
                <p>Everything you type is <strong>auto-saved locally</strong> in this browser for that persona & trigger.</p>
            </div>

            <!-- NEW: clickable personalization matrix -->
            <div class="personalization-panel">
                <div class="personalization-header">
                    <h3>Prioritize Personalization Points</h3>
                    <p>
                        Use this as a cheat-sheet when selecting your <strong>Persona</strong> and <strong>Trigger</strong>.
                        Lead with high-intent <strong>Buying Triggers</strong>, layer in <strong>Network Connections</strong>,
                        <strong>Personal Traits</strong>, <strong>Company Traits</strong>, <strong>Buyer Behaviors</strong> and
                        <strong>Buyer History</strong>.
                    </p>
                </div>

                <div class="personalization-legend">
                    <span class="legend-item">
                        <span class="legend-dot most"></span> Most Effective
                    </span>
                    <span class="legend-item">
                        <span class="legend-dot moderate"></span> Moderately Effective
                    </span>
                    <span class="legend-item">
                        <span class="legend-dot least"></span> Least Effective (but still useful)
                    </span>
                </div>

                <div class="personalization-columns">
                    <!-- Buying Triggers -->
                    <div class="personalization-column">
                        <h4>Buying<br>Triggers</h4>
                        <button class="personalization-pill pill-most"
                                data-category="Buying Triggers"
                                data-label="IPO"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">IPO</button>
                        <button class="personalization-pill pill-most"
                                data-category="Buying Triggers"
                                data-label="New Funding"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">New Funding</button>
                        <button class="personalization-pill pill-most"
                                data-category="Buying Triggers"
                                data-label="Mergers, Acquisitions &amp; Divestures"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">Mergers, Acquisitions &amp; Divestures</button>
                        <button class="personalization-pill pill-most"
                                data-category="Buying Triggers"
                                data-label="Proxy Results"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">Proxy Results</button>
                        <button class="personalization-pill pill-most"
                                data-category="Buying Triggers"
                                data-label="8-K Filing"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">8-K Filing</button>
                    </div>

                    <!-- Network Connections -->
                    <div class="personalization-column">
                        <h4>Network<br>Connections</h4>
                        <button class="personalization-pill pill-moderate"
                                data-category="Network Connections"
                                data-label="Board Overlap"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Board Overlap</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Network Connections"
                                data-label="Customer Connections"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Customer Connections</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Network Connections"
                                data-label="Executive Connections"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Executive Connections</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Network Connections"
                                data-label="Shared Diligent Investors"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Shared Diligent Investors</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Network Connections"
                                data-label="Recent Diligent Vendors"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Recent Diligent Vendors</button>
                    </div>

                    <!-- Personal Traits -->
                    <div class="personalization-column">
                        <h4>Personal<br>Traits</h4>
                        <button class="personalization-pill pill-least"
                                data-category="Personal Traits"
                                data-label="LinkedIn Headline"
                                data-effectiveness="Least Effective"
                                onclick="handlePersonalizationPillClick(this)">LinkedIn Headline</button>
                        <button class="personalization-pill pill-least"
                                data-category="Personal Traits"
                                data-label="LinkedIn Job Descriptions"
                                data-effectiveness="Least Effective"
                                onclick="handlePersonalizationPillClick(this)">LinkedIn Job Descriptions</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Personal Traits"
                                data-label="Certifications &amp; Achievements"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Certifications &amp; Achievements</button>
                        <button class="personalization-pill pill-least"
                                data-category="Personal Traits"
                                data-label="Personal Interests"
                                data-effectiveness="Least Effective"
                                onclick="handlePersonalizationPillClick(this)">Personal Interests</button>
                        <button class="personalization-pill pill-least"
                                data-category="Personal Traits"
                                data-label="Recommendations"
                                data-effectiveness="Least Effective"
                                onclick="handlePersonalizationPillClick(this)">Recommendations</button>
                    </div>

                    <!-- Company Traits -->
                    <div class="personalization-column">
                        <h4>Company<br>Traits</h4>
                        <button class="personalization-pill pill-most"
                                data-category="Company Traits"
                                data-label="10K Risk Factors"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">10K Risk Factors</button>
                        <button class="personalization-pill pill-most"
                                data-category="Company Traits"
                                data-label="Strategic Initiatives"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">Strategic Initiatives</button>
                        <button class="personalization-pill pill-most"
                                data-category="Company Traits"
                                data-label="Stated Values"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">Stated Values</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Company Traits"
                                data-label="Product Growth"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Product Growth</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Company Traits"
                                data-label="Regional Expansion"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Regional Expansion</button>
                    </div>

                    <!-- Buyer Behaviors -->
                    <div class="personalization-column">
                        <h4>Buyer<br>Behaviors</h4>
                        <button class="personalization-pill pill-moderate"
                                data-category="Buyer Behaviors"
                                data-label="New to Company"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">New to Company</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Buyer Behaviors"
                                data-label="Recent Promotion"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Recent Promotion</button>
                        <button class="personalization-pill pill-least"
                                data-category="Buyer Behaviors"
                                data-label="LinkedIn Activity"
                                data-effectiveness="Least Effective"
                                onclick="handlePersonalizationPillClick(this)">LinkedIn Activity</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Buyer Behaviors"
                                data-label="Team Hiring"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Team Hiring</button>
                        <button class="personalization-pill pill-most"
                                data-category="Buyer Behaviors"
                                data-label="Previous User"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">Previous User</button>
                    </div>

                    <!-- Buyer History -->
                    <div class="personalization-column">
                        <h4>Buyer<br>History</h4>
                        <button class="personalization-pill pill-most"
                                data-category="Buyer History"
                                data-label="Previous Opportunity"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">Previous Opportunity</button>
                        <button class="personalization-pill pill-least"
                                data-category="Buyer History"
                                data-label="Ghosted Meeting"
                                data-effectiveness="Least Effective"
                                onclick="handlePersonalizationPillClick(this)">Ghosted Meeting</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Buyer History"
                                data-label="Previous Conversation"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Previous Conversation</button>
                        <button class="personalization-pill pill-most"
                                data-category="Buyer History"
                                data-label="Past Contact / Demo Request"
                                data-effectiveness="Most Effective"
                                onclick="handlePersonalizationPillClick(this)">Past Contact / Demo Request</button>
                        <button class="personalization-pill pill-moderate"
                                data-category="Buyer History"
                                data-label="Previous Replies"
                                data-effectiveness="Moderately Effective"
                                onclick="handlePersonalizationPillClick(this)">Previous Replies</button>
                    </div>
                </div>

                <div id="personalization-tip" class="personalization-tip">
                    Click a tile to generate a quick opener cue linked to your selected persona.
                </div>
            </div>

            <div class="controls-bar">
                <div class="controls-grid">
                    <div class="trigger-selector">
                        <div class="trigger-selector-row">
                            <label for="discovery-persona-select">Persona:</label>
                            <select id="discovery-persona-select" onchange="switchPersona(this.value)">
                                <!-- Personas populated by JS -->
                            </select>
                        </div>
                        <div class="trigger-selector-row">
                            <label for="trigger-select">Sales Trigger:</label>
                            <select id="trigger-select" onchange="switchTrigger(this.value)">
                                <!-- Triggers populated by JS -->
                            </select>
                        </div>
                        <div class="trigger-help">
                            Select a persona (e.g. Company Secretary, CRO), then the customer event youâ€™re responding to (e.g. AGM, New Funding).
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-new" type="button" onclick="showNewTriggerModal()">+ New Persona Trigger</button>
                        <button class="btn btn-delete" type="button" onclick="deleteTrigger()">Delete Trigger</button>
                        <button class="btn btn-export" type="button" onclick="exportToPDF()">Export / Print</button>
                    </div>
                </div>
                <div class="save-indicator" id="save-indicator">ðŸŸ¢ Changes auto-save as you type</div>
            </div>

            <div id="trigger-summary" class="trigger-summary" style="display:none;">
                <div class="trigger-summary-title" id="trigger-summary-title"></div>
                <div class="trigger-summary-body" id="trigger-summary-body"></div>
            </div>

            <div id="discovery-grid" class="discovery-grid">
                <!-- Discovery cards injected by JS -->
            </div>
        </div>

        <!-- TAB: MESSAGING LIBRARY -->
        <div id="tab-messaging" class="tab-content">
            <div class="info-panel">
                <h2>Messaging Library</h2>
                <p>
                    Build reusable messaging mapped to your <strong>Persona + Trigger</strong> work.
                    Filter by persona, trigger and channel to find the right template.
                </p>
            </div>

            <div class="messaging-layout">
                <div class="messaging-filters-card">
                    <h3>Filters & Personas</h3>
                    <p>Tap a persona chip or drill down by trigger and channel.</p>

                    <div id="persona-chips" class="persona-chips">
                        <!-- persona chips -->
                    </div>

                    <div class="filter-row">
                        <div>
                            <div class="filter-label">Persona</div>
                            <select id="filter-persona-select"></select>
                        </div>
                        <div>
                            <div class="filter-label">Sales Trigger</div>
                            <select id="filter-trigger-select"></select>
                        </div>
                        <div>
                            <div class="filter-label">Channel / Step</div>
                            <select id="filter-channel-select"></select>
                        </div>
                    </div>

                    <div class="messaging-actions">
                        <button class="btn btn-secondary" type="button" onclick="resetMessagingFilters()">Reset</button>
                        <button class="btn btn-new" type="button" onclick="showMessageModal()">+ Add Message</button>
                    </div>
                </div>

                <div class="messaging-results">
                    <div class="messaging-results-header">
                        <h3>Message Templates</h3>
                        <div class="results-meta" id="msg-results-meta">0 results</div>
                    </div>

                    <div class="sequence-toggle">
                        <label>
                            <input type="checkbox" id="view-sequence-toggle">
                            View as sequence (Step 1 â†’ Step 2 â†’ Call)
                        </label>
                    </div>

                    <div id="messaging-results-list">
                        <!-- Message cards populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: CALL PROSPECTING -->
        <div id="tab-call-prospecting" class="tab-content">
            <div class="info-panel">
                <h2>Call Prospecting â€“ Command of the First 30 Seconds</h2>
                <p>
                    Use your existing <strong>Persona</strong> + <strong>Trigger</strong> work to drive
                    a consistent cold call opening. This tab loads the standalone Call Prospecting tool
                    so its design, logic and shortcuts stay exactly as you built them.
                </p>
                <ul>
                    <li>Keep Discovery and Messaging flows untouched.</li>
                    <li>Run live calls from the Call Prospecting view.</li>
                    <li>Refine openers based on what lands in real conversations.</li>
                </ul>
            </div>

            <div class="call-iframe-wrapper">
                <iframe
                    src="call-prospecting.html"
                    title="Call Prospecting Tool"
                    class="call-iframe"
                    loading="lazy">
                </iframe>
            </div>
        </div>

        <!-- New Trigger Modal -->
        <div id="new-trigger-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Persona Trigger</h2>
                    <p>Define a new sales trigger event under a persona and its discovery sequence.</p>
                </div>
                <div class="form-group">
                    <label>Persona</label>
                    <input type="text" id="new-trigger-persona" placeholder="e.g. Company Secretary, CRO">
                    <button class="ai-btn ai-btn-small" type="button" onclick="showAITriggerIdeas()" style="margin-top: 8px;">
                        ðŸ¤– Get Trigger Ideas with AI
                    </button>
                </div>
                <div class="form-group">
                    <label>Trigger Name</label>
                    <input type="text" id="new-trigger-name" placeholder="e.g. AGM & Board Pack Preparation">
                </div>
                <div class="form-group">
                    <label>Trigger Description</label>
                    <input type="text" id="new-trigger-description" placeholder="e.g. Preparing board packs and documentation ahead of AGM / board cycle">
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-cancel" type="button" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-new" type="button" onclick="createTrigger()">Create Trigger</button>
                </div>
            </div>
        </div>

        <!-- New / Edit Messaging Modal -->
        <div id="new-message-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="message-modal-title">Add Messaging Template</h2>
                    <p>Create or edit an Outreach-ready template mapped to a persona and trigger.</p>
                </div>

                <div class="form-group">
                    <label for="msg-persona-input">Persona</label>
                    <input type="text" id="msg-persona-input" placeholder="e.g. Company Secretary, CRO, VP Sales">
                </div>

                <div class="form-group">
                    <label for="msg-trigger-select">Sales Trigger</label>
                    <select id="msg-trigger-select">
                        <!-- populated from discovery triggers -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="msg-channel-input">Channel / Step</label>
                    <input type="text" id="msg-channel-input" placeholder="e.g. Outreach Email â€“ Step 1, Call Opener, LinkedIn InMail">
                </div>

                <div class="form-group">
                    <label for="msg-subject-input">Subject / Hook</label>
                    <input type="text" id="msg-subject-input" placeholder="e.g. Ahead of your AGM â€“ quick question on board packs">
                </div>

                <div class="form-group">
                    <label for="msg-body-input">Body</label>
                    <textarea id="msg-body-input" placeholder="Write the full message body. Use tokens like {{first_name}}, {{company}}, {{agm_date}}."></textarea>
                </div>

                <div class="modal-buttons">
                    <button class="btn btn-cancel" type="button" onclick="closeMessageModal()">Cancel</button>
                    <button class="btn btn-new" type="button" onclick="saveMessage()">Save Template</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /***********************
         * DISCOVERY BUILDER
         ***********************/
        const STORAGE_KEY_DISCOVERY = 'discoverySequencesV2';
        const STORAGE_KEY_MESSAGES = 'messagingLibraryV2';

        const discoverySequenceTemplate = [
            {
                step: 1,
                title: "Current State",
                description: "What's happening today? What's working? What's not?",
                aiSection: "current-state",
                defaultQuestions:
"â€¢ Can you walk me through how you're handling [process] today?\n" +
"â€¢ What's working well with your current approach?\n" +
"â€¢ What challenges are you experiencing?\n" +
"â€¢ How long have you been doing it this way?",
                examples: "Example: \"How are you currently managing your sales forecasting process? What tools or spreadsheets are you using?\""
            },
            {
                step: 2,
                title: "Problems & Pain Points",
                description: "What specific challenges are you facing?",
                aiSection: "problems",
                defaultQuestions:
"â€¢ What are the biggest pain points with your current approach?\n" +
"â€¢ Where do you see gaps or inefficiencies?\n" +
"â€¢ What keeps you up at night about this?\n" +
"â€¢ What would happen if you don't address this?",
                examples: "Example: \"When you miss your forecast, what downstream effects does that have on the business?\""
            },
            {
                step: 3,
                title: "Business Impact",
                description: "What's the business impact of those problems?",
                aiSection: "business-impact",
                defaultQuestions:
"â€¢ How is this affecting your revenue/costs/efficiency?\n" +
"â€¢ What's the financial impact of this problem?\n" +
"â€¢ How does this impact other departments or teams?\n" +
"â€¢ What metrics or KPIs are being affected?",
                examples: "Example: \"Can you quantify the cost of inaccurate forecasts? Both in terms of missed opportunities and wasted resources?\""
            },
            {
                step: 4,
                title: "Root Cause Analysis",
                description: "Why do these problems exist?",
                aiSection: "root-cause",
                defaultQuestions:
"â€¢ What's causing these issues?\n" +
"â€¢ Why hasn't this been solved before?\n" +
"â€¢ What have you tried in the past?\n" +
"â€¢ What prevented previous solutions from working?",
                examples: "Example: \"Why do you think your current system struggles with real-time visibility? Is it a data issue, a process issue, or a technology limitation?\""
            },
            {
                step: 5,
                title: "Decision Criteria",
                description: "What would an ideal solution look like?",
                aiSection: "decision-criteria",
                defaultQuestions:
"â€¢ What capabilities are must-haves vs. nice-to-haves?\n" +
"â€¢ How will you evaluate potential solutions?\n" +
"â€¢ What are your top 3 decision criteria?\n" +
"â€¢ What would make you choose one solution over another?",
                examples: "Example: \"If you could wave a magic wand and have the perfect solution, what would it include? What would it NOT include?\""
            },
            {
                step: 6,
                title: "Required Outcomes",
                description: "What results would make this a success?",
                aiSection: "required-outcomes",
                defaultQuestions:
"â€¢ What specific outcomes do you need to achieve?\n" +
"â€¢ How will you measure success?\n" +
"â€¢ What would success look like in 6 months? 12 months?\n" +
"â€¢ What would justify the investment for you?\n" +
"â€¢ Who else needs to see value from this?",
                examples: "Example: \"In 12 months, what would need to be different for you to consider this project a success? What metrics would you point to?\""
            }
        ];

        let triggers = {};          // map id -> {id, persona, name, description, sequence}
        let currentTriggerId = null;
        let currentPersona = null;

        function createEmptySequence() {
            return discoverySequenceTemplate.map(step => ({
                step: step.step,
                title: step.title,
                description: step.description,
                aiSection: step.aiSection,
                coreQuestions: step.defaultQuestions,
                examples: step.examples,
                notes: "",
                customQuestions: ""
            }));
        }

        // ===== AI ENHANCEMENT FUNCTIONS (Moved here to be available early) =====

        function showAITriggerIdeas() {
            const persona = document.getElementById('new-trigger-persona').value.trim();
            
            if (!persona) {
                alert('âš ï¸ Please enter a persona first (e.g., CFO, CTO, VP Sales)');
                return;
            }
            
            const prompts = [
                {
                    title: "Prompt 1: Buying Triggers & Events",
                    prompt: `List 10-15 specific buying triggers or events that would make a ${persona} actively look for a solution.

Focus on:
- Company events (funding, M&A, IPO, leadership changes)
- Market/industry events (regulations, competitive threats)
- Personal events (new role, promotion, team expansion)
- Operational events (system failures, audit findings, compliance deadlines)
- Financial events (budget cycles, earnings misses, cost pressures)

Format as a prioritized list with:
1. Trigger name
2. Why it matters to a ${persona}
3. Urgency level (High/Medium/Low)

Be specific to the ${persona} role and responsibilities.`
                },
                {
                    title: "Prompt 2: Pain Point Triggers",
                    prompt: `A ${persona} experiences these pain points. For each, suggest 3-5 specific trigger events:

Pain Categories for ${persona}:
1. Operational inefficiency
2. Compliance/Risk exposure
3. Budget/Cost pressures
4. Team/Resource constraints
5. Technology/System limitations

For each trigger:
- What event signals this pain
- How to detect it (LinkedIn, news, filings)
- Why ${persona} would care right now

Format as: Category â†’ Trigger â†’ Detection â†’ Why Now`
                },
                {
                    title: "Prompt 3: Industry-Specific Triggers",
                    prompt: `Based on ${persona} responsibilities, list industry-specific triggers:

Sectors:
- SaaS/Technology
- Financial Services
- Healthcare
- Manufacturing
- Retail/E-commerce

For each sector:
- 5 most common triggers for ${persona}
- What makes each trigger relevant
- How recent the trigger should be

Focus on triggers that create urgency and budget availability.`
                }
            ];
            
            showAIModal('Trigger Ideas for ' + persona, prompts);
        }

        function showAIPrompt(section) {
            console.log('showAIPrompt called with section:', section);
            
            const personaSelect = document.getElementById('discovery-persona-select');
            const triggerSelect = document.getElementById('trigger-select');
            
            console.log('personaSelect:', personaSelect);
            console.log('triggerSelect:', triggerSelect);
            console.log('personaSelect.value:', personaSelect?.value);
            console.log('triggerSelect.value:', triggerSelect?.value);
            
            if (!personaSelect || !triggerSelect || !personaSelect.value || !triggerSelect.value) {
                alert('âš ï¸ Please select a Persona and Trigger first');
                return;
            }
            
            const persona = personaSelect.options[personaSelect.selectedIndex].text;
            const trigger = triggerSelect.options[triggerSelect.selectedIndex].text;
            
            console.log('Persona:', persona, 'Trigger:', trigger);
            
            const promptGenerators = {
                'current-state': generateCurrentStatePrompts,
                'problems': generateProblemsPrompts,
                'business-impact': generateBusinessImpactPrompts,
                'root-cause': generateRootCausePrompts,
                'decision-criteria': generateDecisionCriteriaPrompts,
                'required-outcomes': generateRequiredOutcomesPrompts
            };
            
            const sectionTitles = {
                'current-state': 'Current State',
                'problems': 'Problems & Pain Points',
                'business-impact': 'Business Impact',
                'root-cause': 'Root Cause Analysis',
                'decision-criteria': 'Decision Criteria',
                'required-outcomes': 'Required Outcomes'
            };
            
            const generator = promptGenerators[section];
            console.log('Generator found:', !!generator, 'for section:', section);
            
            if (generator) {
                const prompts = generator(persona, trigger);
                console.log('Generated prompts:', prompts);
                showAIModal(`${sectionTitles[section]}: ${persona} - ${trigger}`, prompts);
            } else {
                console.error('No generator found for section:', section);
                alert('âš ï¸ Error: No prompt generator found for this section');
            }
        }

        function generateCurrentStatePrompts(persona, trigger) {
            return [
                {
                    title: "Current State Discovery",
                    prompt: `You're speaking with a ${persona} who just experienced: ${trigger}

Generate discovery questions and expected answers for CURRENT STATE:

1. SITUATION QUESTIONS (3-5):
   - What systems/processes do they use today?
   - What's their current workflow?
   - Who's involved?
   - What tools are they using?

2. EXPECTED CURRENT STATE:
   - What is a typical ${persona} doing today?
   - What's working for them?
   - What's the status quo?
   - Why haven't they changed yet?

3. BASELINE METRICS:
   - What KPIs matter to ${persona}?
   - What's typical before ${trigger}?
   - What just changed because of ${trigger}?

Format: Question â†’ Expected Answer â†’ Follow-up`
                }
            ];
        }

        function generateProblemsPrompts(persona, trigger) {
            return [
                {
                    title: "Pain Point Discovery",
                    prompt: `A ${persona} just experienced ${trigger}. Generate pain point analysis:

1. IMMEDIATE PROBLEMS:
   - What's broken right now?
   - What's causing stress?
   - What keeps them up at night?

2. OPERATIONAL PROBLEMS:
   - What processes are failing?
   - What's taking too long?
   - What's error-prone?

3. STRATEGIC PROBLEMS:
   - What goals can't they achieve?
   - What opportunities are missed?

4. FINANCIAL PROBLEMS:
   - What's costing too much?
   - What's generating waste?

For each:
- Describe the pain
- Rate severity (1-10)
- Link to ${trigger}
- Provide discovery questions`
                }
            ];
        }

        function generateBusinessImpactPrompts(persona, trigger) {
            return [
                {
                    title: "Business Impact Analysis",
                    prompt: `A ${persona} experiencing ${trigger} faces business impacts. Quantify them:

1. FINANCIAL IMPACT:
   - Revenue impact (lost deals, churn)
   - Cost impact (wasted time, inefficiency)
   - Risk impact (compliance, security)
   
   Provide:
   - Typical $ range for ${persona}'s company
   - How to calculate it
   - Discovery questions

2. OPERATIONAL IMPACT:
   - Time wasted per week/month
   - People affected
   - Productivity loss %

3. STRATEGIC IMPACT:
   - Goals at risk
   - Competitive disadvantage
   - Market share loss

Link each to ${trigger} and provide implication questions.`
                }
            ];
        }

        function generateRootCausePrompts(persona, trigger) {
            return [
                {
                    title: "Root Cause Discovery",
                    prompt: `A ${persona} has pain from ${trigger}. Use "5 Whys":

SURFACE PROBLEM: [The obvious pain]

WHY 1: What's causing it?
WHY 2: What's causing that?
WHY 3: What's the systemic issue?
WHY 4: What organizational factor?
WHY 5: What's the true root cause?

For ${persona} + ${trigger}:
1. Generate 3 common surface problems
2. Drill down through 5 levels each
3. Identify root causes
4. Provide discovery questions per level
5. Explain why ${trigger} exposes roots`
                }
            ];
        }

        function generateDecisionCriteriaPrompts(persona, trigger) {
            return [
                {
                    title: "Decision Criteria Framework",
                    prompt: `A ${persona} evaluating solutions after ${trigger}:

1. MUST-HAVE CRITERIA:
   - What's non-negotiable?
   - Why must-haves for ${persona}?
   - How does ${trigger} make these critical?

2. SHOULD-HAVE CRITERIA:
   - What's highly valued but negotiable?
   - What creates advantage?

3. NICE-TO-HAVE:
   - What's differentiating but not critical?

4. EVALUATION FACTORS:
   - Technical fit
   - Vendor viability
   - Implementation complexity
   - Total cost
   - Time to value

For each:
- Why ${persona} cares
- Link to ${trigger}
- Discovery questions`
                }
            ];
        }

        function generateRequiredOutcomesPrompts(persona, trigger) {
            return [
                {
                    title: "Required Outcomes Framework",
                    prompt: `A ${persona} solving ${trigger} problems needs outcomes:

1. QUANTITATIVE (Measurable):
   - Revenue: $X increase
   - Time saved: X hours/month
   - Cost reduction: Y%
   - Efficiency: Z% improvement
   
   Provide realistic targets for ${persona}

2. QUALITATIVE:
   - Reduced stress
   - Better decisions
   - Team morale

3. STRATEGIC:
   - Competitive advantage
   - Market position
   - Scalability

4. SUCCESS CRITERIA:
   - 30-day: What's different?
   - 90-day: Milestones?
   - 1-year: Transformation?

Link to ${trigger} with need-payoff questions.`
                }
            ];
        }

        function showAIModal(title, prompts) {
            console.log('showAIModal called');
            console.log('Title:', title);
            console.log('Prompts:', prompts);
            
            let html = `
                <div class="ai-prompt-modal" id="ai-modal" onclick="if(event.target === this) closeAIModal()">
                    <div class="ai-prompt-content">
                        <div class="ai-prompt-header">
                            <h3>ðŸ¤– ${title}</h3>
                            <button class="ai-prompt-close" onclick="closeAIModal()">âœ• Close</button>
                        </div>
            `;
            
            prompts.forEach((p, index) => {
                html += `
                        <div class="ai-prompt-box">
                            <button class="copy-prompt-btn" onclick="copyAIPrompt('prompt-${index}', event)">ðŸ“‹ Copy</button>
                            <h4>${p.title}</h4>
                            <p style="color: #cbd5e0; margin-bottom: 10px; font-size: 0.9em;">Copy and paste into ChatGPT or Claude:</p>
                            <pre id="prompt-${index}">${p.prompt}</pre>
                        </div>
                `;
            });
            
            html += `
                        <div class="ai-usage-tip">
                            <strong>ðŸ’¡ How to Use:</strong> Copy each prompt â†’ Paste into ChatGPT or Claude â†’ Use the responses to fill in your Discovery Builder. The more context you provide (company name, industry, size), the better the results.
                        </div>
                    </div>
                </div>
            `;
            
            console.log('Inserting modal HTML into body');
            document.body.insertAdjacentHTML('beforeend', html);
            
            // CRITICAL: CSS has display:none by default, we must override it
            const modal = document.getElementById('ai-modal');
            if (modal) {
                modal.style.display = 'block';
            }
            
            document.body.style.overflow = 'hidden';
            
            console.log('Modal should be visible now');
            console.log('Modal element:', modal);
            console.log('Modal display style:', modal ? window.getComputedStyle(modal).display : 'N/A');
            console.log('Modal z-index:', modal ? window.getComputedStyle(modal).zIndex : 'N/A');
        }

        function closeAIModal() {
            const modal = document.getElementById('ai-modal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = 'auto';
        }

        function copyAIPrompt(promptId, event) {
            event.stopPropagation();
            const prompt = document.getElementById(promptId).textContent;
            
            navigator.clipboard.writeText(prompt).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(() => {
                alert('âš ï¸ Please select and copy the prompt manually');
            });
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAIModal();
            }
        });

        console.log('âœ… AI-Enhanced Discovery Builder loaded');



        function createSampleTriggers() {
            const persona = "Company Secretary";
            const agmId = 'trigger-agm-' + Date.now();

            const base = createEmptySequence();
            const agmSequence = base.map(s => ({ ...s }));

            triggers[agmId] = {
                id: agmId,
                persona,
                name: "AGM & Board Pack Preparation",
                description: "Preparing and circulating board packs and AGM documentation for directors and stakeholders.",
                sequence: agmSequence
            };

            const croFundingId = 'trigger-cro-funding-' + Date.now();
            triggers[croFundingId] = {
                id: croFundingId,
                persona: "CRO",
                name: "New Funding Round",
                description: "New funding secured; pressure to prove GTM efficiency and pipeline coverage.",
                sequence: createEmptySequence()
            };

            currentPersona = persona;
            currentTriggerId = agmId;
            saveDiscoveryToStorage();
        }

        function loadDiscoveryFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_DISCOVERY);
                if (!saved) return false;
                const parsed = JSON.parse(saved);
                if (!parsed || typeof parsed !== 'object') return false;
                triggers = parsed;
                return true;
            } catch (e) {
                console.error('Failed to parse discovery model from storage', e);
                return false;
            }
        }

        function saveDiscoveryToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY_DISCOVERY, JSON.stringify(triggers));
            } catch (e) {
                console.error('Failed to save discovery model', e);
            }
            const indicator = document.getElementById('save-indicator');
            if (indicator) {
                indicator.innerHTML = 'âœ“ All changes auto-saved';
                setTimeout(() => {
                    indicator.innerHTML = 'ðŸŸ¢ Changes auto-save as you type';
                }, 2000);
            }
        }

        function getAllPersonas() {
            const set = new Set();
            Object.values(triggers).forEach(t => {
                set.add(t.persona || 'General');
            });
            return Array.from(set).sort();
        }

        function renderPersonaSelector() {
            const select = document.getElementById('discovery-persona-select');
            const personas = getAllPersonas();

            if (!personas.length) {
                select.innerHTML = '<option>No personas defined</option>';
                currentPersona = null;
                return;
            }

            if (!currentPersona || !personas.includes(currentPersona)) {
                currentPersona = personas[0];
            }

            select.innerHTML = personas
                .map(p => `<option value="${p}" ${p === currentPersona ? 'selected' : ''}>${p}</option>`)
                .join('');
        }

        function updateTriggerSummary(trigger) {
            const panel = document.getElementById('trigger-summary');
            const titleEl = document.getElementById('trigger-summary-title');
            const bodyEl = document.getElementById('trigger-summary-body');

            if (!trigger) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            titleEl.textContent = `${trigger.persona} â†’ ${trigger.name}`;
            bodyEl.textContent = trigger.description || '';
        }

        function renderTriggerSelectorForPersona() {
            const select = document.getElementById('trigger-select');
            const grid = document.getElementById('discovery-grid');

            if (!currentPersona) {
                select.innerHTML = '<option>Select a persona first</option>';
                grid.innerHTML = '';
                updateTriggerSummary(null);
                return;
            }

            const personaTriggers = Object.values(triggers)
                .filter(t => (t.persona || 'General') === currentPersona);

            if (!personaTriggers.length) {
                select.innerHTML = '<option>No triggers for this persona</option>';
                grid.innerHTML = '';
                updateTriggerSummary(null);
                return;
            }

            if (!currentTriggerId || !personaTriggers.find(t => t.id === currentTriggerId)) {
                currentTriggerId = personaTriggers[0].id;
            }

            select.innerHTML = personaTriggers
                .map(t => `<option value="${t.id}" ${t.id === currentTriggerId ? 'selected' : ''}>${t.name}</option>`)
                .join('');

            renderDiscoveryGridForTrigger(currentTriggerId);
        }

        function renderDiscoveryGridForTrigger(triggerId) {
            const trigger = triggers[triggerId];
            const grid = document.getElementById('discovery-grid');
            if (!trigger || !grid) return;

            if (!Array.isArray(trigger.sequence)) {
                trigger.sequence = createEmptySequence();
                saveDiscoveryToStorage();
            }

            updateTriggerSummary(trigger);

            const totalSteps = discoverySequenceTemplate.length;
            grid.innerHTML = trigger.sequence.map((item, index) => `
                <div class="discovery-card">
                    <div class="discovery-header">
                        <div class="discovery-number">${item.step}</div>
                        <div class="discovery-title">
                            <h3>${item.title}</h3>
                            <p>${item.description}</p>
                            <div class="step-meta">Step ${item.step} of ${totalSteps}</div>
                        </div>
                    </div>
                    
                    <button class="ai-btn ai-btn-small" type="button" onclick="showAIPrompt('${item.aiSection || 'current-state'}')" style="margin-bottom: 12px;">
                        ðŸ¤– AI Help for ${item.title}
                    </button>

                    <div class="discovery-content">
                        <label>ðŸ“ Your Notes &amp; Approach</label>
                        <textarea id="notes-${index}" placeholder="Add your specific approach, context, or notes for this persona & trigger.">${item.notes || ''}</textarea>
                    </div>

                    <div class="questions-section">
                        <h4>ðŸ’¬ Discovery Questions</h4>

                        <div class="core-questions">
                            <div class="core-questions-label">Core Questions (standard, non-editable)</div>
                            <div class="core-questions-body">
                                ${item.coreQuestions || ''}
                            </div>
                        </div>

                        <div class="custom-questions">
                            <label class="custom-questions-label">âœï¸ Your Custom Questions for this persona & trigger</label>
                            <textarea id="custom-questions-${index}" placeholder="Tailor or add new questions for this persona & trigger.">${item.customQuestions || ''}</textarea>
                        </div>

                        <div class="example-box">
                            <button class="example-toggle" type="button" data-index="${index}">
                                â–¶ Show example usage
                            </button>
                            <div class="example-content collapsed">
                                ${item.examples || ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function saveCurrentTrigger() {
            if (!currentTriggerId || !triggers[currentTriggerId]) return;
            const trigger = triggers[currentTriggerId];

            if (!Array.isArray(trigger.sequence)) {
                trigger.sequence = createEmptySequence();
            }

            trigger.sequence.forEach((item, index) => {
                const notesEl = document.getElementById(`notes-${index}`);
                const customEl = document.getElementById(`custom-questions-${index}`);

                if (notesEl) item.notes = notesEl.value;
                if (customEl) item.customQuestions = customEl.value;
            });

            saveDiscoveryToStorage();
        }

        function switchPersona(persona) {
            saveCurrentTrigger();
            currentPersona = persona;
            renderTriggerSelectorForPersona();
            refreshTriggerOptionsForMessaging();
        }

        function switchTrigger(triggerId) {
            saveCurrentTrigger();
            currentTriggerId = triggerId;
            renderDiscoveryGridForTrigger(triggerId);
            refreshTriggerOptionsForMessaging();
        }

        function showNewTriggerModal() {
            const personaSelect = document.getElementById('discovery-persona-select');
            const current = personaSelect && personaSelect.value !== 'Select a persona first'
                ? personaSelect.value
                : '';

            document.getElementById('new-trigger-persona').value = current || '';
            document.getElementById('new-trigger-name').value = '';
            document.getElementById('new-trigger-description').value = '';
            document.getElementById('new-trigger-modal').style.display = 'block';
            document.getElementById('new-trigger-persona').focus();
        }

        function closeModal() {
            document.getElementById('new-trigger-modal').style.display = 'none';
        }

        function createTrigger() {
            const persona = document.getElementById('new-trigger-persona').value.trim() || 'General';
            const name = document.getElementById('new-trigger-name').value.trim();
            const description = document.getElementById('new-trigger-description').value.trim();

            if (!name) {
                alert('Please enter a trigger name');
                return;
            }

            const id = 'trigger-' + Date.now();
            triggers[id] = {
                id,
                persona,
                name,
                description: description || 'Custom sales trigger',
                sequence: createEmptySequence()
            };

            currentPersona = persona;
            currentTriggerId = id;
            saveDiscoveryToStorage();
            renderPersonaSelector();
            renderTriggerSelectorForPersona();
            closeModal();
            refreshTriggerOptionsForMessaging();
        }

        function deleteTrigger() {
            const keys = Object.keys(triggers);
            if (keys.length <= 1) {
                alert('Cannot delete the last trigger. Create a new one first.');
                return;
            }

            const trigger = triggers[currentTriggerId];
            if (!trigger) return;

            if (!confirm(`Delete trigger "${trigger.name}" for persona "${trigger.persona}"? This cannot be undone.`)) {
                return;
            }

            delete triggers[currentTriggerId];

            const personas = getAllPersonas();
            currentPersona = personas[0] || null;
            currentTriggerId = Object.keys(triggers)[0] || null;

            saveDiscoveryToStorage();
            renderPersonaSelector();
            renderTriggerSelectorForPersona();
            refreshTriggerOptionsForMessaging();
        }

        function exportToPDF() {
            saveCurrentTrigger();
            window.print();
        }

        // Auto-save on textarea input
        document.addEventListener('input', function (e) {
            if (
                e.target.tagName === 'TEXTAREA' &&
                (e.target.id.startsWith('notes-') || e.target.id.startsWith('custom-questions-'))
            ) {
                clearTimeout(window.saveTimer);
                window.saveTimer = setTimeout(() => {
                    saveCurrentTrigger();
                }, 800);
            }
        });

        // Collapsible examples
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('example-toggle')) {
                const content = e.target.closest('.example-box').querySelector('.example-content');
                if (!content) return;

                const isCollapsed = content.classList.contains('collapsed');
                if (isCollapsed) {
                    content.classList.remove('collapsed');
                    e.target.innerHTML = 'â–¼ Hide example usage';
                } else {
                    content.classList.add('collapsed');
                    e.target.innerHTML = 'â–¶ Show example usage';
                }
            }
        });

        // Close trigger modal on outside click
        document.getElementById('new-trigger-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        /***********************
         * TAB SWITCHING
         ***********************/
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('tab-btn')) {
                const tab = e.target.getAttribute('data-tab');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(ct => ct.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.add('active');
            }
        });

        /***********************
         * MESSAGING LIBRARY
         ***********************/
        let messagingLibrary = [];
        let editingMessageId = null;
        const defaultPersonas = ["Company Secretary", "CRO", "CFO"];

        function loadMessagingFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_MESSAGES);
                if (!saved) return false;
                const parsed = JSON.parse(saved);
                if (!Array.isArray(parsed)) return false;
                messagingLibrary = parsed;
                return true;
            } catch (e) {
                console.error('Failed to parse messaging library', e);
                return false;
            }
        }

        function saveMessagingToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY_MESSAGES, JSON.stringify(messagingLibrary));
            } catch (e) {
                console.error('Failed to save messaging library', e);
            }
        }

        function createSampleMessaging() {
            messagingLibrary = [
                {
                    id: 'msg-1',
                    persona: 'Company Secretary',
                    triggerName: 'AGM & Board Pack Preparation',
                    triggerId: null,
                    channel: 'Outreach Email â€“ Step 1',
                    subject: 'Ahead of your next AGM â€“ quick question on board packs',
                    body:
"Hi {{first_name}},\n\n" +
"I work with CoSecs who are preparing for AGM and board cycles and keep running into last-minute fire drills on packs.\n\n" +
"Would you be open to a short conversation on how others are tightening version control and director experience around their packs?\n\n" +
"Best,\n{{sender_name}}"
                }
            ];
        }

        function getAllMessagingPersonas() {
            const set = new Set(defaultPersonas);
            messagingLibrary.forEach(m => set.add(m.persona));
            return Array.from(set).sort();
        }

        function buildMessagingFilters() {
            const personaSelect = document.getElementById('filter-persona-select');
            const triggerSelect = document.getElementById('filter-trigger-select');
            const channelSelect = document.getElementById('filter-channel-select');
            const chipsContainer = document.getElementById('persona-chips');

            const personas = getAllMessagingPersonas();
            personaSelect.innerHTML =
                '<option value="any">Any persona</option>' +
                personas.map(p => `<option value="${p}">${p}</option>`).join('');

            const triggerNames = Array.from(new Set(messagingLibrary.map(m => m.triggerName).filter(Boolean))).sort();
            triggerSelect.innerHTML =
                '<option value="any">Any trigger</option>' +
                triggerNames.map(t => `<option value="${t}">${t}</option>`).join('');

            const channels = Array.from(new Set(messagingLibrary.map(m => m.channel).filter(Boolean))).sort();
            channelSelect.innerHTML =
                '<option value="any">Any channel</option>' +
                channels.map(c => `<option value="${c}">${c}</option>`).join('');

            chipsContainer.innerHTML = personas.map(p => `
                <button class="persona-chip" data-persona="${p}" type="button">${p}</button>
            `).join('');
        }

        function getMessagingFilterValues() {
            const persona = document.getElementById('filter-persona-select').value || 'any';
            const triggerName = document.getElementById('filter-trigger-select').value || 'any';
            const channel = document.getElementById('filter-channel-select').value || 'any';
            const sequenceMode = document.getElementById('view-sequence-toggle').checked;
            return { persona, triggerName, channel, sequenceMode };
        }

        function renderMessagingList() {
            const { persona, triggerName, channel, sequenceMode } = getMessagingFilterValues();
            const list = document.getElementById('messaging-results-list');
            const meta = document.getElementById('msg-results-meta');

            let items = messagingLibrary.slice();

            if (persona !== 'any') {
                items = items.filter(m => m.persona === persona);
            }
            if (triggerName !== 'any') {
                items = items.filter(m => m.triggerName === triggerName);
            }
            if (channel !== 'any') {
                items = items.filter(m => m.channel === channel);
            }

            if (sequenceMode) {
                items.sort((a, b) => (a.sequenceOrder || 0) - (b.sequenceOrder || 0));
            }

            meta.textContent = `${items.length} result${items.length === 1 ? '' : 's'}`;

            if (!items.length) {
                list.innerHTML = '<div class="no-results">No templates found. Try adjusting filters or add a new message.</div>';
                return;
            }

            list.innerHTML = items.map(m => `
                <div class="message-card" data-id="${m.id}">
                    <div class="message-card-header">
                        <div class="message-main-info">
                            <div class="message-channel">${m.channel || ''}</div>
                            <h4 class="message-subject">${m.subject || '&nbsp;'}</h4>
                            <div class="tags">
                                <span class="tag persona">${m.persona || 'Persona'}</span>
                                <span class="tag trigger">${m.triggerName || 'Trigger'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="message-body">${(m.body || '').replace(/\n/g, '<br>')}</div>
                    <div class="message-actions">
                        <button class="btn-ghost" type="button" onclick="event.stopPropagation(); copyMessage('${m.id}')">Copy</button>
                        <button class="btn-ghost" type="button" onclick="event.stopPropagation(); editMessage('${m.id}')">Edit</button>
                        <button class="btn-ghost btn-ghost-danger" type="button" onclick="event.stopPropagation(); deleteMessage('${m.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function resetMessagingFilters() {
            document.getElementById('filter-persona-select').value = 'any';
            document.getElementById('filter-trigger-select').value = 'any';
            document.getElementById('filter-channel-select').value = 'any';
            document.getElementById('view-sequence-toggle').checked = false;
            document.querySelectorAll('.persona-chip').forEach(chip => chip.classList.remove('active'));
            renderMessagingList();
        }

        function refreshTriggerOptionsForMessaging() {
            const triggerSelect = document.getElementById('msg-trigger-select');
            if (!triggerSelect) return;

            const options = Object.values(triggers)
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(t => `<option value="${t.id}">${t.persona} â†’ ${t.name}</option>`)
                .join('');

            triggerSelect.innerHTML = '<option value="">(no trigger)</option>' + options;
        }

        function populateTriggerSelectForMessageModal(selectedId) {
            refreshTriggerOptionsForMessaging();
            if (selectedId && document.getElementById('msg-trigger-select').querySelector(`option[value="${selectedId}"]`)) {
                document.getElementById('msg-trigger-select').value = selectedId;
            }
        }

        function showMessageModal(messageId) {
            editingMessageId = messageId || null;
            const title = document.getElementById('message-modal-title');
            const personaInput = document.getElementById('msg-persona-input');
            const triggerSelect = document.getElementById('msg-trigger-select');
            const channelInput = document.getElementById('msg-channel-input');
            const subjectInput = document.getElementById('msg-subject-input');
            const bodyInput = document.getElementById('msg-body-input');

            if (editingMessageId) {
                title.textContent = 'Edit Messaging Template';
                const m = messagingLibrary.find(x => x.id === editingMessageId);
                if (m) {
                    personaInput.value = m.persona || '';
                    channelInput.value = m.channel || '';
                    subjectInput.value = m.subject || '';
                    bodyInput.value = m.body || '';
                    populateTriggerSelectForMessageModal(m.triggerId || '');
                }
            } else {
                title.textContent = 'Add Messaging Template';
                const personaSelect = document.getElementById('discovery-persona-select');
                const triggerSelectDiscovery = document.getElementById('trigger-select');
                personaInput.value = personaSelect ? (personaSelect.value || '') : '';
                channelInput.value = '';
                subjectInput.value = '';
                bodyInput.value = '';
                populateTriggerSelectForMessageModal(triggerSelectDiscovery ? triggerSelectDiscovery.value : '');
            }

            document.getElementById('new-message-modal').style.display = 'block';
        }

        function closeMessageModal() {
            document.getElementById('new-message-modal').style.display = 'none';
            editingMessageId = null;
        }

        document.getElementById('new-message-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeMessageModal();
            }
        });

        function saveMessage() {
            const persona = document.getElementById('msg-persona-input').value.trim();
            const triggerId = document.getElementById('msg-trigger-select').value || null;
            const channel = document.getElementById('msg-channel-input').value.trim();
            const subject = document.getElementById('msg-subject-input').value.trim();
            const body = document.getElementById('msg-body-input').value.trim();

            if (!persona || !subject || !body) {
                alert('Persona, subject and body are required.');
                return;
            }

            let triggerName = '';
            if (triggerId && triggers[triggerId]) {
                triggerName = triggers[triggerId].name;
            }

            if (editingMessageId) {
                const idx = messagingLibrary.findIndex(m => m.id === editingMessageId);
                if (idx !== -1) {
                    messagingLibrary[idx] = {
                        ...messagingLibrary[idx],
                        persona,
                        triggerId,
                        triggerName,
                        channel,
                        subject,
                        body
                    };
                }
            } else {
                messagingLibrary.push({
                    id: 'msg-' + Date.now(),
                    persona,
                    triggerId,
                    triggerName,
                    channel,
                    subject,
                    body
                });
            }

            saveMessagingToStorage();
            buildMessagingFilters();
            renderMessagingList();
            closeMessageModal();
        }

        function editMessage(id) {
            showMessageModal(id);
        }

        function deleteMessage(id) {
            if (!confirm('Delete this message template?')) return;
            messagingLibrary = messagingLibrary.filter(m => m.id !== id);
            saveMessagingToStorage();
            buildMessagingFilters();
            renderMessagingList();
        }

        function copyMessage(id) {
            const m = messagingLibrary.find(x => x.id === id);
            if (!m) return;
            const text = `${m.subject}\n\n${m.body}`;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard');
            }).catch(() => {
                alert('Copy failed; please copy manually.');
            });
        }

        // Click to expand message body
        document.addEventListener('click', function (e) {
            const card = e.target.closest('.message-card');
            if (card && !e.target.classList.contains('btn-ghost') && !e.target.classList.contains('btn-ghost-danger')) {
                card.classList.toggle('expanded');
            }

            if (e.target.classList.contains('persona-chip')) {
                const persona = e.target.getAttribute('data-persona');
                document.querySelectorAll('.persona-chip').forEach(chip => chip.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('filter-persona-select').value = persona;
                renderMessagingList();
            }
        });

        // Save all on page unload
        window.addEventListener('beforeunload', function () {
            saveCurrentTrigger();
            saveMessagingToStorage();
        });

        /***********************
         * PERSONALIZATION PILL HANDLER
         ***********************/
        function handlePersonalizationPillClick(btn) {
            const personaSelect = document.getElementById('discovery-persona-select');
            const persona = personaSelect && personaSelect.value
                ? personaSelect.value
                : 'this persona';

            document.querySelectorAll('.personalization-pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');

            const category = btn.getAttribute('data-category') || 'Personalization';
            const label = btn.getAttribute('data-label') || btn.textContent.trim();
            const effectiveness = btn.getAttribute('data-effectiveness') || '';

            const tip = document.getElementById('personalization-tip');
            if (tip) {
                tip.innerHTML =
                    `<strong>${label}</strong> (${category}) selected â€“ weave this into your opener for <strong>${persona}</strong>` +
                    (effectiveness ? ` <em>[${effectiveness.toLowerCase()} signal]</em>.` : '.');
            }
        }

        /***********************
         * INITIALIZE
         ***********************/
        function initializeAll() {
            // Discovery model
            const loadedDiscovery = loadDiscoveryFromStorage();
            if (!loadedDiscovery) {
                createSampleTriggers();
            } else {
                // Ensure structure & persona fields are present
                Object.values(triggers).forEach((t, idx) => {
                    if (!t.persona) t.persona = 'General';
                    if (!Array.isArray(t.sequence)) {
                        t.sequence = createEmptySequence();
                    }
                    t.sequence = t.sequence.map((item, i) => {
                        const template = discoverySequenceTemplate[i] || {};
                        return {
                            step: item.step || template.step || (i + 1),
                            title: item.title || template.title || "",
                            description: item.description || template.description || "",
                            aiSection: item.aiSection || template.aiSection || "current-state",
                            coreQuestions: item.coreQuestions || item.questions || template.defaultQuestions || "",
                            examples: item.examples || template.examples || "",
                            notes: item.notes || "",
                            customQuestions: item.customQuestions || ""
                        };
                    });
                });

                const personas = getAllPersonas();
                currentPersona = personas[0] || null;
                const firstTrigger = Object.values(triggers).find(t => t.persona === currentPersona) || Object.values(triggers)[0];
                currentTriggerId = firstTrigger ? firstTrigger.id : null;
            }

            renderPersonaSelector();
            renderTriggerSelectorForPersona();

            // Messaging model
            const loadedMessaging = loadMessagingFromStorage();
            if (!loadedMessaging) {
                createSampleMessaging();
                saveMessagingToStorage();
            }

            buildMessagingFilters();
            renderMessagingList();
            populateTriggerSelectForMessageModal('any');
        }

        // ===== AI ENHANCEMENT FUNCTIONS =====
        
        document.addEventListener('DOMContentLoaded', initializeAll);
    </script>
</body>
</html>