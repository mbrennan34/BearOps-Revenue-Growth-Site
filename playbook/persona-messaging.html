<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery & Persona Messaging Workspace - BearOps</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0A1628 0%, #1a2942 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.08);
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-nav {
            text-align: center;
            margin-bottom: 20px;
        }

        .lead-link-gradient {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .lead-link-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Tab switcher */
        .tab-switcher {
            display: inline-flex;
            margin: 10px auto 20px;
            padding: 4px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .tab-btn {
            border: none;
            background: transparent;
            color: #cbd5f5;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
        }

        .tab-content {
            display: none;
            margin-top: 10px;
        }

        .tab-content.active {
            display: block;
        }

        /* Info panel */
        .info-panel {
            background: rgba(15, 23, 42, 0.85);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .info-panel h2 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: #e5e7eb;
        }

        .info-panel p {
            font-size: 0.95rem;
            color: #cbd5f5;
            margin-bottom: 8px;
        }

        .info-panel ul {
            margin-left: 18px;
            margin-top: 4px;
        }

        .info-panel li {
            font-size: 0.9rem;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .controls-bar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: center;
        }

        .trigger-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .trigger-selector-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .trigger-selector label {
            font-weight: 600;
            color: #667eea;
            white-space: nowrap;
        }

        .trigger-selector select {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .trigger-selector select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.15);
        }

        .trigger-selector select option {
            background: #1a2942;
            color: white;
        }

        .trigger-help {
            font-size: 0.8rem;
            color: rgba(226, 232, 255, 0.7);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-new {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-delete {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.25);
            color: #e5e7eb;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.4);
        }

        .save-indicator {
            text-align: right;
            margin-top: 15px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .trigger-summary {
            margin-bottom: 20px;
            padding: 16px 18px;
            background: rgba(30, 64, 175, 0.24);
            border-radius: 14px;
            border-left: 4px solid #667eea;
        }

        .trigger-summary-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }

        .trigger-summary-body {
            font-size: 0.9rem;
            color: #c7d2fe;
        }

        .trigger-summary-meta {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        .discovery-grid {
            display: grid;
            gap: 25px;
        }

        .discovery-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        .discovery-card:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .discovery-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .discovery-number {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .discovery-title {
            flex: 1;
        }

        .discovery-title h3 {
            font-size: 1.3rem;
            color: #667eea;
            margin-bottom: 5px;
        }

        .discovery-title p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .step-meta {
            font-size: 0.8rem;
            color: rgba(191, 219, 254, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .discovery-content {
            margin-bottom: 16px;
        }

        .discovery-content label {
            display: block;
            font-weight: 600;
            color: #48bb78;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .discovery-content textarea {
            width: 100%;
            min-height: 90px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .discovery-content textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .questions-section {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
        }

        .questions-section h4 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.05rem;
        }

        .core-questions {
            margin-bottom: 12px;
        }

        .core-questions-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(219, 234, 254, 0.95);
            margin-bottom: 6px;
        }

        .core-questions-body {
            font-size: 0.88rem;
            color: rgba(226, 232, 255, 0.9);
            background: rgba(15, 23, 42, 0.7);
            border-radius: 8px;
            padding: 10px 12px;
            border: 1px solid rgba(129, 140, 248, 0.4);
            white-space: pre-line;
        }

        .custom-questions-label {
            display: block;
            font-weight: 600;
            color: #22c55e;
            margin-top: 10px;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .custom-questions textarea {
            width: 100%;
            min-height: 90px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.7);
            border: 2px solid rgba(148, 163, 184, 0.4);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            resize: vertical;
        }

        .custom-questions textarea:focus {
            outline: none;
            border-color: #22c55e;
            background: rgba(22, 101, 52, 0.3);
        }

        .example-box {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #48bb78;
        }

        .example-toggle {
            border: none;
            background: transparent;
            color: #bbf7d0;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .example-toggle:hover {
            text-decoration: underline;
        }

        .example-content {
            margin-top: 8px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.75);
            line-height: 1.6;
            font-style: italic;
            white-space: pre-line;
        }

        .example-content.collapsed {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .modal-content {
            max-width: 600px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1a2942 0%, #0A1628 100%);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .modal-header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #48bb78;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Messaging Library */
        .messaging-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 2fr);
            gap: 20px;
        }

        .messaging-filters-card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 18px 20px 20px;
            height: fit-content;
        }

        .messaging-filters-card h3 {
            font-size: 1.05rem;
            margin-bottom: 6px;
            color: #e5e7eb;
        }

        .messaging-filters-card p {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 14px;
        }

        .persona-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .persona-chip {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.8);
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            font-size: 0.8rem;
            padding: 4px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .persona-chip:hover {
            background: rgba(99, 102, 241, 0.3);
            border-color: #6366f1;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 10px;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .messaging-filters-card select {
            width: 100%;
            padding: 8px 10px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.7);
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 0.9rem;
        }

        .messaging-filters-card select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .messaging-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .messaging-results {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 18px 20px 20px;
            min-height: 150px;
        }

        .messaging-results-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 6px;
        }

        .messaging-results-header h3 {
            font-size: 1.05rem;
            color: #e5e7eb;
        }

        .results-meta {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .sequence-toggle {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sequence-toggle input {
            accent-color: #6366f1;
        }

        .message-card {
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 12px 14px;
            margin-top: 10px;
            background: rgba(15, 23, 42, 0.9);
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .message-card:hover {
            border-color: #6366f1;
            background: rgba(30, 64, 175, 0.3);
        }

        .message-header-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 4px;
        }

        .message-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e5e7eb;
        }

        .sequence-step-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #86efac;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .message-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            font-size: 0.75rem;
            border-radius: 999px;
            padding: 2px 8px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: #e5e7eb;
        }

        .tag.trigger {
            border-color: #6366f1;
            color: #c7d2fe;
        }

        .tag.persona {
            border-color: #22c55e;
            color: #bbf7d0;
        }

        .message-channel {
            font-size: 0.8rem;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .message-subject {
            font-size: 0.85rem;
            color: #e5e7eb;
        }

        .message-body {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed rgba(148, 163, 184, 0.5);
            font-size: 0.85rem;
            color: #e5e7eb;
            white-space: pre-line;
            display: none;
        }

        .message-card.expanded .message-body {
            display: block;
        }

        .message-card.expanded {
            border-color: #22c55e;
        }

        .message-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-ghost {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            background: transparent;
            color: #e5e7eb;
            font-size: 0.75rem;
            padding: 4px 10px;
            cursor: pointer;
        }

        .btn-ghost:hover {
            background: rgba(148, 163, 184, 0.25);
        }

        .btn-ghost-danger {
            border-color: #f97373;
            color: #fecaca;
        }

        .btn-ghost-danger:hover {
            background: rgba(248, 113, 113, 0.25);
        }

        .no-results {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-top: 12px;
        }

        @media print {
            .controls-bar,
            .top-nav,
            .btn,
            .info-panel,
            img,
            .tab-switcher,
            #tab-messaging {
                display: none !important;
            }

            body {
                background: white;
                color: #000;
            }

            .discovery-card {
                box-shadow: none;
                border-radius: 0;
                border: 1px solid #ccc;
            }
        }

        @media (max-width: 900px) {
            .messaging-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 12px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                justify-content: stretch;
                flex-wrap: wrap;
            }

            .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Overlaid logo (doesn't change layout) -->
    <img src="../assets/images/BearOps_Logo_Default.png" alt="BearOps Logo">

    <div class="container">
        <div class="top-nav">
            <a href="../process/sales-playbook-hub/sales-playbook.html" class="lead-link-gradient">Playbook Hub</a>
        </div>

        <div class="header">
            <div class="logo">üîç Discovery & Persona Messaging Workspace</div>
            <div class="tab-switcher">
                <button class="tab-btn active" data-tab="discovery">Discovery Builder</button>
                <button class="tab-btn" data-tab="messaging">Messaging Library</button>
            </div>
        </div>

        <!-- TAB: DISCOVERY BUILDER -->
        <div id="tab-discovery" class="tab-content active">
            <div class="info-panel">
                <h2>Discovery Builder (Persona ‚Üí Trigger)</h2>
                <p>
                    Start with a <strong>Persona</strong>, then select the relevant <strong>Sales Trigger</strong> for that persona.
                    Each persona+trigger combination has its own 6-step discovery flow:
                </p>
                <ul>
                    <li><strong>Current State</strong></li>
                    <li><strong>Problems & Pain Points</strong></li>
                    <li><strong>Business Impact</strong></li>
                    <li><strong>Root Cause Analysis</strong></li>
                    <li><strong>Decision Criteria</strong></li>
                    <li><strong>Required Outcomes</strong></li>
                </ul>
                <p>Everything you type is <strong>auto-saved locally</strong> in this browser for that persona & trigger.</p>
            </div>

            <div class="controls-bar">
                <div class="controls-grid">
                    <div class="trigger-selector">
                        <div class="trigger-selector-row">
                            <label for="discovery-persona-select">Persona:</label>
                            <select id="discovery-persona-select" onchange="switchPersona(this.value)">
                                <!-- Personas populated by JS -->
                            </select>
                        </div>
                        <div class="trigger-selector-row">
                            <label for="trigger-select">Sales Trigger:</label>
                            <select id="trigger-select" onchange="switchTrigger(this.value)">
                                <!-- Triggers populated by JS -->
                            </select>
                        </div>
                        <div class="trigger-help">
                            Select a persona (e.g., Company Secretary, CRO), then the customer event you‚Äôre responding to (e.g., AGM, New Funding).
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-new" onclick="showNewTriggerModal()">+ New Trigger</button>
                        <button class="btn btn-delete" onclick="deleteTrigger()">üóëÔ∏è Delete Trigger</button>
                        <button class="btn btn-export" onclick="exportToPDF()">üìÑ Export</button>
                    </div>
                </div>
                <div class="save-indicator">
                    <span id="save-indicator">üü¢ Changes auto-save as you type</span>
                </div>
            </div>

            <div id="trigger-summary" class="trigger-summary" style="display:none;"></div>

            <div class="discovery-grid" id="discovery-grid">
                <!-- Discovery cards populated by JavaScript -->
            </div>
        </div>

        <!-- TAB: MESSAGING LIBRARY -->
        <div id="tab-messaging" class="tab-content">
            <div class="info-panel">
                <h2>Persona-First Messaging Library (Outreach-Ready)</h2>
                <p>
                    The Messaging Library re-uses your <strong>Personas & Triggers</strong> from Discovery to build Outreach-ready messaging.
                </p>
                <ul>
                    <li>Start with <strong>Persona</strong> (chips or dropdown).</li>
                    <li>Filter by <strong>Trigger</strong> (coming from Discovery + current messages).</li>
                    <li>Use <strong>View as sequence</strong> to see Email 1 ‚Üí Email 2 ‚Üí Call in order.</li>
                </ul>
            </div>

            <div class="messaging-layout">
                <div class="messaging-filters-card">
                    <h3>Filter Messaging</h3>
                    <p>Everything revolves around the persona you‚Äôre targeting.</p>

                    <div class="persona-chips">
                        <button class="persona-chip" data-persona="Company Secretary">Company Secretary</button>
                        <button class="persona-chip" data-persona="CRO">CRO</button>
                        <button class="persona-chip" data-persona="CFO">CFO</button>
                    </div>

                    <div class="filter-row">
                        <div>
                            <div class="filter-label">Persona</div>
                            <select id="msg-filter-persona">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div>
                            <div class="filter-label">Sales Trigger</div>
                            <select id="msg-filter-trigger">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>

                    <div class="messaging-actions">
                        <button class="btn btn-secondary" type="button" onclick="resetMessagingFilters()">Reset</button>
                        <button class="btn btn-new" type="button" onclick="showMessageModal()">+ Add Message</button>
                    </div>
                </div>

                <div class="messaging-results">
                    <div class="messaging-results-header">
                        <h3>Message Templates</h3>
                        <div class="results-meta" id="msg-results-meta">0 results</div>
                    </div>

                    <div class="sequence-toggle">
                        <label>
                            <input type="checkbox" id="view-sequence-toggle">
                            View as sequence (Step 1 ‚Üí Step 2 ‚Üí Call)
                        </label>
                    </div>

                    <div id="messaging-results-list">
                        <!-- Message cards populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Trigger Modal -->
    <div id="new-trigger-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Persona Trigger</h2>
                <p>Define a new sales trigger event under a persona and its discovery sequence.</p>
            </div>
            <div class="form-group">
                <label>Persona</label>
                <input type="text" id="new-trigger-persona" placeholder="e.g., Company Secretary, CRO">
            </div>
            <div class="form-group">
                <label>Trigger Name</label>
                <input type="text" id="new-trigger-name" placeholder="e.g., AGM & Board Pack Preparation">
            </div>
            <div class="form-group">
                <label>Trigger Description</label>
                <input type="text" id="new-trigger-description" placeholder="e.g., Preparing board packs and documentation ahead of AGM / board cycle">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-cancel" type="button" onclick="closeModal()">Cancel</button>
                <button class="btn btn-new" type="button" onclick="createTrigger()">Create Trigger</button>
            </div>
        </div>
    </div>

    <!-- New / Edit Messaging Modal -->
    <div id="new-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="message-modal-title">Add Messaging Template</h2>
                <p>Create or edit an Outreach-ready template mapped to a persona and trigger.</p>
            </div>

            <div class="form-group">
                <label for="msg-persona-input">Persona</label>
                <input type="text" id="msg-persona-input" placeholder="e.g., Company Secretary, CRO, VP Sales">
            </div>

            <div class="form-group">
                <label for="msg-trigger-select">Sales Trigger</label>
                <select id="msg-trigger-select">
                    <!-- populated from discovery triggers -->
                </select>
            </div>

            <div class="form-group">
                <label for="msg-channel-input">Channel / Step</label>
                <input type="text" id="msg-channel-input" placeholder="e.g., Outreach Email ‚Äì Step 1, Call Opener, LinkedIn InMail">
            </div>

            <div class="form-group">
                <label for="msg-subject-input">Subject / Hook</label>
                <input type="text" id="msg-subject-input" placeholder="e.g., Ahead of your AGM ‚Äì quick question on board packs">
            </div>

            <div class="form-group">
                <label for="msg-body-input">Body</label>
                <textarea id="msg-body-input" placeholder="Write the full message body. Use tokens like {{first_name}}, {{company}}, {{agm_date}}."></textarea>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-cancel" type="button" onclick="closeMessageModal()">Cancel</button>
                <button class="btn btn-new" type="button" onclick="saveMessage()">Save Template</button>
            </div>
        </div>
    </div>

    <script>
        /***********************
         * DISCOVERY BUILDER
         * Persona ‚Üí Trigger ‚Üí 6 Steps
         ***********************/
        const discoverySequenceTemplate = [
            {
                step: 1,
                title: "Current State",
                description: "What's happening today? What's working? What's not?",
                defaultQuestions:
"‚Ä¢ Can you walk me through how you're handling [process] today?\n" +
"‚Ä¢ What's working well with your current approach?\n" +
"‚Ä¢ What challenges are you experiencing?\n" +
"‚Ä¢ How long have you been doing it this way?",
                examples: "Example: 'How are you currently managing your sales forecasting process? What tools or spreadsheets are you using?'"
            },
            {
                step: 2,
                title: "Problems & Pain Points",
                description: "What specific challenges are you facing?",
                defaultQuestions:
"‚Ä¢ What are the biggest pain points with your current approach?\n" +
"‚Ä¢ Where do you see gaps or inefficiencies?\n" +
"‚Ä¢ What keeps you up at night about this?\n" +
"‚Ä¢ What would happen if you don't address this?",
                examples: "Example: 'When you miss your forecast, what downstream effects does that have on the business?'"
            },
            {
                step: 3,
                title: "Business Impact",
                description: "What's the business impact of those problems?",
                defaultQuestions:
"‚Ä¢ How is this affecting your revenue/costs/efficiency?\n" +
"‚Ä¢ What's the financial impact of this problem?\n" +
"‚Ä¢ How does this impact other departments or teams?\n" +
"‚Ä¢ What metrics or KPIs are being affected?",
                examples: "Example: 'Can you quantify the cost of inaccurate forecasts? Both in terms of missed opportunities and wasted resources?'"
            },
            {
                step: 4,
                title: "Root Cause Analysis",
                description: "Why do these problems exist?",
                defaultQuestions:
"‚Ä¢ What's causing these issues?\n" +
"‚Ä¢ Why hasn't this been solved before?\n" +
"‚Ä¢ What have you tried in the past?\n" +
"‚Ä¢ What prevented previous solutions from working?",
                examples: "Example: 'Why do you think your current system struggles with real-time visibility? Is it a data issue, a process issue, or a technology limitation?'"
            },
            {
                step: 5,
                title: "Decision Criteria",
                description: "What would an ideal solution look like?",
                defaultQuestions:
"‚Ä¢ What capabilities are must-haves vs. nice-to-haves?\n" +
"‚Ä¢ How will you evaluate potential solutions?\n" +
"‚Ä¢ What are your top 3 decision criteria?\n" +
"‚Ä¢ What would make you choose one solution over another?",
                examples: "Example: 'If you could wave a magic wand and have the perfect solution, what would it include? What would it NOT include?'"
            },
            {
                step: 6,
                title: "Required Outcomes",
                description: "What results would make this a success?",
                defaultQuestions:
"‚Ä¢ What specific outcomes do you need to achieve?\n" +
"‚Ä¢ How will you measure success?\n" +
"‚Ä¢ What would success look like in 6 months? 12 months?\n" +
"‚Ä¢ What would justify the investment for you?\n" +
"‚Ä¢ Who else needs to see value from this?",
                examples: "Example: 'In 12 months, what would need to be different for you to consider this project a success? What metrics would you point to?'"
            }
        ];

        const STORAGE_KEY_DISCOVERY = 'discoverySequencesV2';

        let triggers = {};          // {id: {id, persona, name, description, sequence: [...]}}
        let currentTriggerId = null;
        let currentPersona = null;

        function createEmptySequence() {
            return discoverySequenceTemplate.map(step => ({
                step: step.step,
                title: step.title,
                description: step.description,
                coreQuestions: step.defaultQuestions,
                examples: step.examples,
                notes: "",
                customQuestions: ""
            }));
        }

        function createSampleTriggers() {
            // Example persona: Company Secretary with fully tailored AGM discovery
            const persona = "Company Secretary";

            const agmId = 'trigger-agm-' + Date.now();

            const base = createEmptySequence();
            const agmSequence = base.map((step, idx) => {
                const s = { ...step };

                if (s.step === 1) {
                    s.notes =
"Use this step to get a clear, factual view of how AGM and board cycles are run today.\n\n" +
"Anchor around:\n" +
"- How board packs are assembled (Word / PowerPoint / PDFs)\n" +
"- How documents are shared (email, shared drives, couriers)\n" +
"- Who is involved (CoSec team, Finance, Legal, Execs, Chair)\n" +
"- Where last-minute changes typically come from\n\n" +
"Goal: Visualise the ‚Äòmess‚Äô without judging it. Get them talking through the real workflow so you can reference it later when you position Diligent.";

                    s.customQuestions =
"‚Ä¢ For your AGM and regular board meetings, how are packs currently compiled and circulated to directors?\n" +
"‚Ä¢ Do you rely more on email, shared drives, USB keys, or a mix of channels?\n" +
"‚Ä¢ How many different versions of the pack typically exist before you finalise it?\n" +
"‚Ä¢ When a director requests a change close to the meeting, how is that managed and communicated to everyone?\n" +
"‚Ä¢ Who owns the final sign-off on the board pack before it goes to the Chair and directors?\n" +
"‚Ä¢ How do you currently store and retrieve previous packs, minutes and resolutions for audit or regulatory queries?";

                    s.examples =
"Example: \"Talk me through the last AGM cycle at {{company}} from your perspective.\n" +
"Where did the board papers start, who contributed, and how did you ultimately send the final pack to directors?\"";
                }

                if (s.step === 2) {
                    s.notes =
"Here you surface the pain beneath that process.\n\n" +
"Key angles to probe:\n" +
"- Version control chaos (multiple PDFs, unclear ‚Äòfinal‚Äô)\n" +
"- Fire drills and late nights before meetings\n" +
"- Sensitivity of the content vs. how it‚Äôs actually sent (email risk)\n" +
"- Directors frustrated about receiving the wrong or late version\n\n" +
"You want vivid language you can re-use in your recap and in your emails (\"fire drills\", \"last-minute scramble\", \"not confident everyone has the right version\").";

                    s.customQuestions =
"‚Ä¢ What typically goes wrong in the run-up to AGMs or key board meetings with your current process?\n" +
"‚Ä¢ How often do you find yourself chasing directors or executives for updated slides or papers at the last minute?\n" +
"‚Ä¢ Do you ever run into confusion about which version of a paper is actually the final, approved one?\n" +
"‚Ä¢ Have you had situations where a director arrived with the wrong pack or an outdated version of a document?\n" +
"‚Ä¢ How much time in the week before an AGM is spent on manual tasks like compiling, attaching, or re-sending PDFs?\n" +
"‚Ä¢ What parts of this process feel most stressful or high-risk from your perspective as Company Secretary?";

                    s.examples =
"Example: \"When something changes late in the day ‚Äì a revised paper from Finance or Legal ‚Äì\n" +
"what happens? How confident are you that every director is always looking at the latest version?\"";
                }

                if (s.step === 3) {
                    s.notes =
"Now connect those pains to business and governance impact.\n\n" +
"Focus on:\n" +
"- Time cost for CoSec and support team\n" +
"- Board effectiveness (directors prepared or not)\n" +
"- Governance and regulatory risk (e.g. misinformed decisions, incomplete records)\n" +
"- Reputational risk with Chair and board if the process feels amateur or chaotic\n\n" +
"This is where you set up ROI: hours saved, reduced risk, better experience for board & regulators.";

                    s.customQuestions =
"‚Ä¢ When these issues happen (version confusion, late changes, missing materials), what does that mean for the AGM or board meeting itself?\n" +
"‚Ä¢ How much time do you and your team lose every cycle dealing with rework, chasing updates, and validating the ‚Äòright‚Äô version?\n" +
"‚Ä¢ Have you ever had to apologise to the Chair or board because materials weren‚Äôt aligned or were sent late?\n" +
"‚Ä¢ From a governance or regulatory standpoint, what risks do you see in relying on email and shared drives for sensitive board content?\n" +
"‚Ä¢ If you had to quantify it, what proportion of your AGM/board prep time is spent on low-value admin vs. supporting the Chair and board strategically?";

                    s.examples =
"Example: \"If a director makes a decision based on an outdated version of a paper,\n" +
"what does that create for you ‚Äì both in terms of governance risk and trust with the board?\"";
                }

                if (s.step === 4) {
                    s.notes =
"This step separates symptoms (fire drills) from causes.\n\n" +
"Explore root causes like:\n" +
"- Email & shared drives not designed for board-level governance\n" +
"- No single, controlled source of truth for packs\n" +
"- Fragmented ownership between CoSec, IT, and business units\n" +
"- Previous attempts to fix it with more manual controls or generic tools\n\n" +
"Goal: help them articulate that the problem is structural ‚Äì not that the CoSec team simply needs to \"work harder\".";

                    s.customQuestions =
"‚Ä¢ Why do you think these problems persist today, given how critical AGMs and board meetings are?\n" +
"‚Ä¢ Is the bottleneck more about technology, process, or the way different teams contribute to the board pack?\n" +
"‚Ä¢ Have you tried any workarounds in the past (e.g., stricter email rules, shared folders, internal portals)? Did they stick?\n" +
"‚Ä¢ What stopped previous attempts to improve this from really taking hold?\n" +
"‚Ä¢ How much of this is within your direct control versus dependent on IT, Legal, or other functions?";

                    s.examples =
"Example: \"It sounds like the process has grown up around email and shared drives over time.\n" +
"Why do you think it‚Äôs been so hard to move away from that ‚Äì is it tools, change fatigue, or other priorities taking over?\"";
                }

                if (s.step === 5) {
                    s.notes =
"Here you shape the buying criteria around Diligent‚Äôs strengths.\n\n" +
"Steer gently toward:\n" +
"- Security and control appropriate for board content\n" +
"- A single, up-to-date source of truth for packs and minutes\n" +
"- Ease of use for busy directors (any device, intuitive UX)\n" +
"- Robust audit trail and reporting for regulators and internal audits\n" +
"- Ability to handle late changes without chaos\n\n" +
"You want 3‚Äì5 clear ‚Äòmust-haves‚Äô that map directly to Diligent‚Äôs value props.";

                    s.customQuestions =
"‚Ä¢ If you were to redesign this from scratch, what are the non-negotiables in a better way of working?\n" +
"‚Ä¢ How important is it that directors have a simple, consistent way to access materials on any device?\n" +
"‚Ä¢ What expectations does your Chair ‚Äì or your regulator ‚Äì have around security, audit trail, and record-keeping?\n" +
"‚Ä¢ How critical is it that you can make late updates to packs without introducing confusion about versions?\n" +
"‚Ä¢ When you look at potential solutions, which matters more: director experience, governance/audit, or time saved for your team ‚Äì or do all three need to be there?";

                    s.examples =
"Example: \"If you could wave a magic wand and design the ideal board portal for AGMs and regular meetings,\n" +
"what capabilities would it absolutely need to have, and which would just be ‚Äònice-to-haves‚Äô?\"";
                }

                if (s.step === 6) {
                    s.notes =
"This is where you anchor success metrics and buy-in.\n\n" +
"Push for:\n" +
"- Concrete time savings in the weeks before AGMs/board meetings\n" +
"- Fewer last-minute fire drills and re-sends\n" +
"- Higher confidence from the Chair and directors that materials are complete and current\n" +
"- Stronger governance posture (clear audit trail, easier regulatory responses)\n\n" +
"These outcomes will feed directly into your proposal, mutual action plan, and messaging tone.";

                    s.customQuestions =
"‚Ä¢ In 6‚Äì12 months, what would need to be true for you to say, \"We‚Äôve transformed how we run AGMs and board cycles\"?\n" +
"‚Ä¢ Is there a target reduction in time or number of last-minute issues you‚Äôd like to see for your team?\n" +
"‚Ä¢ What feedback would you like to hear from your Chair and directors after a few cycles on a new system?\n" +
"‚Ä¢ From a governance and regulatory standpoint, what outcomes would give you the most peace of mind?\n" +
"‚Ä¢ Who else internally needs to see clear value from this (e.g., Legal, Risk, IT, the board itself) for a project to move forward?";

                    s.examples =
"Example: \"If we were having this conversation again after your next AGM cycle,\n" +
"what specific changes ‚Äì in time saved, fewer fire drills, or board feedback ‚Äì would tell you this had been a success?\"";
                }

                return s;
            });

            triggers[agmId] = {
                id: agmId,
                persona,
                name: "AGM & Board Pack Preparation",
                description: "Preparing and circulating board packs and AGM documentation for directors and stakeholders",
                sequence: agmSequence
            };

            // Example persona: CRO with a New Funding trigger (generic template)
            const croFundingId = 'trigger-cro-funding-' + Date.now();
            triggers[croFundingId] = {
                id: croFundingId,
                persona: "CRO",
                name: "New Funding Round",
                description: "New funding secured; pressure to prove GTM efficiency and pipeline coverage",
                sequence: createEmptySequence()
            };

            currentPersona = persona;
            currentTriggerId = agmId;
            saveDiscoveryToStorage();
        }

        function loadDiscoveryFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_DISCOVERY);
                if (!saved) return false;
                const parsed = JSON.parse(saved);
                if (!parsed || typeof parsed !== 'object') return false;
                triggers = parsed;
                return true;
            } catch (e) {
                console.error('Failed to parse discovery model from storage', e);
                return false;
            }
        }

        function saveDiscoveryToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY_DISCOVERY, JSON.stringify(triggers));
            } catch (e) {
                console.error('Failed to save discovery model', e);
            }
            const indicator = document.getElementById('save-indicator');
            if (indicator) {
                indicator.innerHTML = '‚úì All changes auto-saved';
                setTimeout(() => {
                    indicator.innerHTML = 'üü¢ Changes auto-save as you type';
                }, 2000);
            }
        }

        function getAllPersonas() {
            const set = new Set();
            Object.values(triggers).forEach(t => {
                set.add(t.persona || 'General');
            });
            return Array.from(set).sort();
        }

        function renderPersonaSelector() {
            const select = document.getElementById('discovery-persona-select');
            const personas = getAllPersonas();

            if (!personas.length) {
                select.innerHTML = '<option>No personas defined</option>';
                currentPersona = null;
                return;
            }

            if (!currentPersona || !personas.includes(currentPersona)) {
                currentPersona = personas[0];
            }

            select.innerHTML = personas
                .map(p => `<option value="${p}" ${p === currentPersona ? 'selected' : ''}>${p}</option>`)
                .join('');
        }

        function renderTriggerSelectorForPersona() {
            const select = document.getElementById('trigger-select');
            const grid = document.getElementById('discovery-grid');

            if (!currentPersona) {
                select.innerHTML = '<option>Select a persona first</option>';
                grid.innerHTML = '';
                updateTriggerSummary(null);
                return;
            }

            const personaTriggers = Object.values(triggers)
                .filter(t => (t.persona || 'General') === currentPersona);

            if (!personaTriggers.length) {
                select.innerHTML = '<option>No triggers for this persona yet</option>';
                grid.innerHTML = '';
                updateTriggerSummary(null);
                return;
            }

            if (!currentTriggerId || !personaTriggers.find(t => t.id === currentTriggerId)) {
                currentTriggerId = personaTriggers[0].id;
            }

            select.innerHTML = personaTriggers
                .map(t => `<option value="${t.id}" ${t.id === currentTriggerId ? 'selected' : ''}>${t.name} - ${t.description}</option>`)
                .join('');

            loadTrigger(currentTriggerId);
        }

        function switchPersona(personaName) {
            saveCurrentTrigger();
            currentPersona = personaName;
            renderTriggerSelectorForPersona();
        }

        function switchTrigger(id) {
            saveCurrentTrigger();
            currentTriggerId = id;
            loadTrigger(id);
        }

        function updateTriggerSummary(trigger) {
            const summaryEl = document.getElementById('trigger-summary');
            if (!trigger) {
                summaryEl.style.display = 'none';
                summaryEl.innerHTML = '';
                return;
            }
            summaryEl.style.display = 'block';
            summaryEl.innerHTML = `
                <div class="trigger-summary-title">
                    Persona: <strong>${trigger.persona}</strong> ‚Ä¢ Trigger: <strong>${trigger.name}</strong>
                </div>
                <div class="trigger-summary-body">
                    ${trigger.description || 'No description provided.'}
                </div>
                <div class="trigger-summary-meta">
                    Changes are saved for this persona & trigger only.
                </div>
            `;
        }

        function loadTrigger(id) {
            const trigger = triggers[id];
            if (!trigger) return;

            if (!Array.isArray(trigger.sequence)) {
                trigger.sequence = createEmptySequence();
                saveDiscoveryToStorage();
            }

            updateTriggerSummary(trigger);

            const grid = document.getElementById('discovery-grid');
            const totalSteps = discoverySequenceTemplate.length;

            grid.innerHTML = trigger.sequence.map((item, index) => `
                <div class="discovery-card">
                    <div class="discovery-header">
                        <div class="discovery-number">${item.step}</div>
                        <div class="discovery-title">
                            <h3>${item.title}</h3>
                            <p>${item.description}</p>
                            <div class="step-meta">Step ${item.step} of ${totalSteps}</div>
                        </div>
                    </div>

                    <div class="discovery-content">
                        <label>üìù Your Notes &amp; Approach</label>
                        <textarea id="notes-${index}" placeholder="Add your specific approach, context, or notes for this persona & trigger...">${item.notes || ''}</textarea>
                    </div>

                    <div class="questions-section">
                        <h4>üí¨ Discovery Questions</h4>

                        <div class="core-questions">
                            <div class="core-questions-label">Core Questions (standard, non-editable)</div>
                            <div class="core-questions-body">
                                ${item.coreQuestions || ''}
                            </div>
                        </div>

                        <div class="custom-questions">
                            <label class="custom-questions-label">‚úèÔ∏è Your Custom Questions for this persona & trigger</label>
                            <textarea id="custom-questions-${index}" placeholder="Tailor or add new questions for this persona & trigger...">${item.customQuestions || ''}</textarea>
                        </div>

                        <div class="example-box">
                            <button class="example-toggle" type="button" data-index="${index}">
                                ‚ñ∂ Show example usage
                            </button>
                            <div class="example-content collapsed">
                                ${item.examples || ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function saveCurrentTrigger() {
            if (!currentTriggerId || !triggers[currentTriggerId]) return;

            const trigger = triggers[currentTriggerId];

            if (!Array.isArray(trigger.sequence)) {
                trigger.sequence = createEmptySequence();
            }

            trigger.sequence.forEach((item, index) => {
                const notesEl = document.getElementById(`notes-${index}`);
                const customEl = document.getElementById(`custom-questions-${index}`);

                if (notesEl) item.notes = notesEl.value;
                if (customEl) item.customQuestions = customEl.value;
            });

            saveDiscoveryToStorage();
        }

        function showNewTriggerModal() {
            const personaSelect = document.getElementById('discovery-persona-select');
            const current = personaSelect && personaSelect.value !== 'Select a persona first'
                ? personaSelect.value
                : '';

            document.getElementById('new-trigger-persona').value = current || '';
            document.getElementById('new-trigger-name').value = '';
            document.getElementById('new-trigger-description').value = '';
            document.getElementById('new-trigger-modal').style.display = 'block';
            document.getElementById('new-trigger-persona').focus();
        }

        function closeModal() {
            document.getElementById('new-trigger-modal').style.display = 'none';
        }

        function createTrigger() {
            const persona = document.getElementById('new-trigger-persona').value.trim() || 'General';
            const name = document.getElementById('new-trigger-name').value.trim();
            const description = document.getElementById('new-trigger-description').value.trim();

            if (!name) {
                alert('Please enter a trigger name');
                return;
            }

            const id = 'trigger-' + Date.now();
            triggers[id] = {
                id,
                persona,
                name,
                description: description || 'Custom sales trigger',
                sequence: createEmptySequence()
            };

            currentPersona = persona;
            currentTriggerId = id;
            saveDiscoveryToStorage();
            renderPersonaSelector();
            renderTriggerSelectorForPersona();
            closeModal();
            refreshTriggerOptionsForMessaging();
        }

        function deleteTrigger() {
            const keys = Object.keys(triggers);
            if (keys.length <= 1) {
                alert('Cannot delete the last trigger. Create a new one first.');
                return;
            }

            const trigger = triggers[currentTriggerId];
            if (!trigger) return;

            if (!confirm(`Delete trigger "${trigger.name}" for persona "${trigger.persona}"? This cannot be undone.`)) {
                return;
            }

            delete triggers[currentTriggerId];

            const personas = getAllPersonas();
            currentPersona = personas[0] || null;
            currentTriggerId = Object.keys(triggers)[0] || null;

            saveDiscoveryToStorage();
            renderPersonaSelector();
            renderTriggerSelectorForPersona();
            refreshTriggerOptionsForMessaging();
        }

        function exportToPDF() {
            saveCurrentTrigger();
            window.print();
        }

        // Auto-save on textarea input
        document.addEventListener('input', function (e) {
            if (
                e.target.tagName === 'TEXTAREA' &&
                (e.target.id.startsWith('notes-') || e.target.id.startsWith('custom-questions-'))
            ) {
                clearTimeout(window.saveTimer);
                window.saveTimer = setTimeout(() => {
                    saveCurrentTrigger();
                }, 800);
            }
        });

        // Collapsible examples
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('example-toggle')) {
                const content = e.target.closest('.example-box').querySelector('.example-content');
                if (!content) return;

                const isCollapsed = content.classList.contains('collapsed');
                if (isCollapsed) {
                    content.classList.remove('collapsed');
                    e.target.innerHTML = '‚ñº Hide example usage';
                } else {
                    content.classList.add('collapsed');
                    e.target.innerHTML = '‚ñ∂ Show example usage';
                }
            }
        });

        // Close trigger modal on outside click
        document.getElementById('new-trigger-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        /***********************
         * TAB SWITCHING
         ***********************/
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('tab-btn')) {
                const tab = e.target.getAttribute('data-tab');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(ct => ct.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.add('active');
            }
        });

        /***********************
         * MESSAGING LIBRARY
         ***********************/
        let messagingLibrary = [];
        let editingMessageId = null;
        const defaultPersonas = ["Company Secretary", "CRO", "CFO"];

        function createSampleMessaging() {
            // Diligent example ‚Äì Company Secretary, AGM trigger
            messagingLibrary = [
                {
                    id: 'msg-1',
                    persona: "Company Secretary",
                    triggerName: "AGM & Board Pack Preparation",
                    channel: "Outreach Email ‚Äì Step 1 (Initial)",
                    subject: "Ahead of your AGM ‚Äì question on board packs & last-minute changes",
                    body:
"Hi {{first_name}},\n\n" +
"I noticed {{company}}‚Äôs AGM is coming up and wanted to reach out in your capacity as Company Secretary.\n\n" +
"Most CoSecs I work with tell me the hardest part of AGM and board cycles isn‚Äôt the meeting itself, it‚Äôs:\n" +
"- Chasing last-minute updates from directors and executives\n" +
"- Version control across board papers and resolutions\n" +
"- Making sure everyone has the right pack, in the right format, at the right time\n" +
"- Keeping an audit trail that satisfies both the board and regulators\n\n" +
"At Diligent, we help company secretaries move this out of email and shared drives into a secure board portal where:\n" +
"- Papers are updated once and synced everywhere\n" +
"- Directors can securely review, annotate and sign from any device\n" +
"- You retain a complete, exportable audit trail for AGMs and board minutes\n\n" +
"Would a short conversation after your upcoming AGM prep window be useful, just to compare how other CoSecs are handling this now?\n\n" +
"Best,\n{{sender_name}}\n{{sender_title}}\nDiligent"
                },
                {
                    id: 'msg-2',
                    persona: "Company Secretary",
                    triggerName: "AGM & Board Pack Preparation",
                    channel: "Outreach Email ‚Äì Step 2 (Follow-up)",
                    subject: "Reducing AGM fire-drills around board packs",
                    body:
"Hi {{first_name}},\n\n" +
"I know AGM season is a busy time and wanted to briefly follow up.\n\n" +
"When we speak with company secretaries post-AGM, a few themes come up again and again:\n" +
"- ‚ÄúWe still rely on email to circulate sensitive board material.‚Äù\n" +
"- ‚ÄúLast-minute changes lead to confusion about which version is final.‚Äù\n" +
"- ‚ÄúWe spend disproportionate time producing packs instead of supporting the Chair and board.‚Äù\n\n" +
"Diligent‚Äôs board governance platform is designed specifically to remove those pain points by:\n" +
"- Centralising board packs, resolutions and AGM documents in one secure portal\n" +
"- Giving directors a single, always-current version (with a full history behind it)\n" +
"- Making it easy to demonstrate good governance to your board and regulators\n\n" +
"Would you be open to a 20-minute session to see how other CoSecs are modernising this ahead of their next AGM cycle?\n\n" +
"Best,\n{{sender_name}}\nDiligent"
                },
                {
                    id: 'msg-3',
                    persona: "Company Secretary",
                    triggerName: "AGM & Board Pack Preparation",
                    channel: "Call Opener ‚Äì Warm",
                    subject: "Call opener",
                    body:
"\"{{first_name}}, thanks for taking the call.\n\n" +
"I‚Äôm speaking with a number of company secretaries who are heading into AGM and board meeting season.\n\n" +
"The pattern is usually the same:\n" +
"- Multiple versions of board papers flying around by email\n" +
"- Last-minute changes from directors and executives\n" +
"- Pressure to keep everything secure and fully auditable for the Chair and the regulator.\n\n" +
"Very simply, my role at Diligent is to show CoSecs how they can move that entire process into a secure board portal ‚Äì so there‚Äôs one source of truth for board packs, a clean audit trail, and fewer late-night fire drills before the AGM.\n\n" +
"Can I ask how you‚Äôre currently managing board papers and AGM documentation at {{company}} today?\""
                }
            ];
        }

        function saveMessagingToStorage() {
            try {
                localStorage.setItem('messagingLibrary', JSON.stringify(messagingLibrary));
            } catch (e) {
                console.error('Failed to save messagingLibrary', e);
            }
        }

        function loadMessagingFromStorage() {
            try {
                const saved = localStorage.getItem('messagingLibrary');
                if (!saved) return false;
                const parsed = JSON.parse(saved);
                if (!Array.isArray(parsed)) return false;
                messagingLibrary = parsed;
                return true;
            } catch (e) {
                console.error('Failed to parse messagingLibrary', e);
                return false;
            }
        }

        function buildMessagingFilters() {
            const triggerFilter = document.getElementById('msg-filter-trigger');
            const personaFilter = document.getElementById('msg-filter-persona');

            const personaSet = new Set();
            // From discovery triggers
            Object.values(triggers).forEach(t => {
                personaSet.add(t.persona || 'General');
            });
            // From existing messages
            messagingLibrary.forEach(m => {
                personaSet.add(m.persona || 'General');
            });
            // Defaults
            defaultPersonas.forEach(p => personaSet.add(p));

            const personas = ['any', ...Array.from(personaSet).sort()];

            personaFilter.innerHTML = personas
                .map(p => `<option value="${p}">${p === 'any' ? 'Any Persona' : p}</option>`)
                .join('');

            personaFilter.onchange = () => {
                updateTriggerFilterForPersona();
                renderMessagingList();
            };

            triggerFilter.onchange = renderMessagingList;

            personaFilter.value = 'any';
            updateTriggerFilterForPersona();
        }

        function updateTriggerFilterForPersona() {
            const triggerFilter = document.getElementById('msg-filter-trigger');
            const personaFilter = document.getElementById('msg-filter-persona');
            const selectedPersona = personaFilter.value;

            const namesFromDiscovery = new Set();
            Object.values(triggers).forEach(t => {
                if (selectedPersona === 'any' || t.persona === selectedPersona) {
                    namesFromDiscovery.add(t.name);
                }
            });

            const namesFromMessaging = new Set(
                messagingLibrary
                    .filter(m => selectedPersona === 'any' || m.persona === selectedPersona)
                    .map(m => m.triggerName)
            );

            const allNames = new Set([...namesFromDiscovery, ...namesFromMessaging]);
            const sorted = Array.from(allNames).sort();

            triggerFilter.innerHTML = ['any', ...sorted]
                .map(t => `<option value="${t}">${t === 'any' ? 'Any Trigger' : t}</option>`)
                .join('');
            triggerFilter.value = 'any';
        }

        function sequenceScore(msg) {
            const ch = (msg.channel || '').toLowerCase();
            if (ch.includes('step 1')) return 1;
            if (ch.includes('step 2')) return 2;
            if (ch.includes('step 3')) return 3;
            if (ch.includes('step 4')) return 4;
            if (ch.includes('call')) return 50;
            if (ch.includes('inmail') || ch.includes('linkedin')) return 40;
            return 30;
        }

        function renderMessagingList() {
            const listEl = document.getElementById('messaging-results-list');
            const metaEl = document.getElementById('msg-results-meta');
            const sequenceMode = document.getElementById('view-sequence-toggle').checked;

            const triggerFilter = document.getElementById('msg-filter-trigger').value;
            const personaFilter = document.getElementById('msg-filter-persona').value;

            const filtered = messagingLibrary.filter(m => {
                const matchesPersona = personaFilter === 'any' || m.persona === personaFilter;
                const matchesTrigger = triggerFilter === 'any' || m.triggerName === triggerFilter;
                return matchesPersona && matchesTrigger;
            });

            metaEl.textContent = `${filtered.length} result${filtered.length === 1 ? '' : 's'}`;

            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="no-results">No messaging templates match these filters yet. Try broadening your filters or add a new message.</div>`;
                return;
            }

            if (!sequenceMode) {
                listEl.innerHTML = filtered.map(m => `
                    <div class="message-card" data-id="${m.id}">
                        <div class="message-header-row">
                            <div class="message-title">${m.subject || '(No subject)'}</div>
                            <div class="message-tags">
                                <span class="tag persona">${m.persona}</span>
                                <span class="tag trigger">${m.triggerName}</span>
                            </div>
                        </div>
                        <div class="message-channel">${m.channel}</div>
                        <div class="message-subject"><strong>Subject / Hook:</strong> ${m.subject || ''}</div>
                        <div class="message-body">
                            ${m.body || ''}
                            <div class="message-actions">
                                <button class="btn-ghost btn-copy-subject" type="button">Copy Subject</button>
                                <button class="btn-ghost btn-copy-body" type="button">Copy Body</button>
                                <button class="btn-ghost btn-edit-message" type="button">Edit</button>
                                <button class="btn-ghost btn-ghost-danger btn-delete-message" type="button">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                const sorted = filtered.slice().sort((a, b) => sequenceScore(a) - sequenceScore(b));
                listEl.innerHTML = sorted.map((m, idx) => `
                    <div class="message-card" data-id="${m.id}">
                        <div class="message-header-row">
                            <div>
                                <div class="sequence-step-label">Step ${idx + 1}</div>
                                <div class="message-title">${m.subject || '(No subject)'}</div>
                            </div>
                            <div class="message-tags">
                                <span class="tag persona">${m.persona}</span>
                                <span class="tag trigger">${m.triggerName}</span>
                            </div>
                        </div>
                        <div class="message-channel">${m.channel}</div>
                        <div class="message-subject"><strong>Subject / Hook:</strong> ${m.subject || ''}</div>
                        <div class="message-body">
                            ${m.body || ''}
                            <div class="message-actions">
                                <button class="btn-ghost btn-copy-subject" type="button">Copy Subject</button>
                                <button class="btn-ghost btn-copy-body" type="button">Copy Body</button>
                                <button class="btn-ghost btn-edit-message" type="button">Edit</button>
                                <button class="btn-ghost btn-ghost-danger btn-delete-message" type="button">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function resetMessagingFilters() {
            const personaFilter = document.getElementById('msg-filter-persona');
            personaFilter.value = 'any';
            document.getElementById('view-sequence-toggle').checked = false;
            updateTriggerFilterForPersona();
            renderMessagingList();
        }

        function populateTriggerSelectForMessageModal(persona = 'any') {
            const select = document.getElementById('msg-trigger-select');
            const names = new Set();

            Object.values(triggers).forEach(t => {
                if (persona === 'any' || t.persona === persona) {
                    names.add(t.name);
                }
            });

            if (persona === 'any') {
                messagingLibrary.forEach(m => names.add(m.triggerName));
            }

            const sorted = Array.from(names).sort();
            select.innerHTML = sorted.map(n => `<option value="${n}">${n}</option>`).join('');
        }

        function refreshTriggerOptionsForMessaging() {
            buildMessagingFilters();
            populateTriggerSelectForMessageModal('any');
        }

        function showMessageModal(messageId = null) {
            const personaFilter = document.getElementById('msg-filter-persona');
            const personaContext = personaFilter ? personaFilter.value : 'any';

            populateTriggerSelectForMessageModal(personaContext);
            const titleEl = document.getElementById('message-modal-title');
            editingMessageId = messageId;

            if (messageId) {
                const msg = messagingLibrary.find(m => m.id === messageId);
                if (!msg) return;
                titleEl.textContent = "Edit Messaging Template";
                document.getElementById('msg-persona-input').value = msg.persona || '';
                document.getElementById('msg-trigger-select').value = msg.triggerName || '';
                document.getElementById('msg-channel-input').value = msg.channel || '';
                document.getElementById('msg-subject-input').value = msg.subject || '';
                document.getElementById('msg-body-input').value = msg.body || '';
            } else {
                titleEl.textContent = "Add Messaging Template";
                const personaValue = personaContext !== 'any' ? personaContext : '';
                document.getElementById('msg-persona-input').value = personaValue;
                document.getElementById('msg-channel-input').value = '';
                document.getElementById('msg-subject-input').value = '';
                document.getElementById('msg-body-input').value = '';
                if (document.getElementById('msg-trigger-select').options.length > 0) {
                    document.getElementById('msg-trigger-select').selectedIndex = 0;
                }
            }

            document.getElementById('new-message-modal').style.display = 'block';
        }

        function closeMessageModal() {
            document.getElementById('new-message-modal').style.display = 'none';
            editingMessageId = null;
        }

        function saveMessage() {
            const persona = document.getElementById('msg-persona-input').value.trim() || 'General';
            const triggerName = document.getElementById('msg-trigger-select').value.trim();
            const channel = document.getElementById('msg-channel-input').value.trim() || 'Outreach Step';
            const subject = document.getElementById('msg-subject-input').value.trim();
            const body = document.getElementById('msg-body-input').value.trim();

            if (!triggerName || !subject || !body) {
                alert('Please include at least Persona, Trigger, Subject, and Body.');
                return;
            }

            if (editingMessageId) {
                const idx = messagingLibrary.findIndex(m => m.id === editingMessageId);
                if (idx !== -1) {
                    messagingLibrary[idx] = {
                        ...messagingLibrary[idx],
                        persona,
                        triggerName,
                        channel,
                        subject,
                        body
                    };
                }
            } else {
                const id = 'msg-' + Date.now();
                messagingLibrary.push({
                    id,
                    persona,
                    triggerName,
                    channel,
                    subject,
                    body
                });
            }

            saveMessagingToStorage();
            buildMessagingFilters();
            renderMessagingList();
            closeMessageModal();
        }

        // Close messaging modal on outside click
        document.getElementById('new-message-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeMessageModal();
            }
        });

        // Persona chips behaviour (messaging tab)
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('persona-chip')) {
                const persona = e.target.getAttribute('data-persona');
                const personaFilter = document.getElementById('msg-filter-persona');

                let opt = Array.from(personaFilter.options).find(o => o.value === persona);
                if (!opt) {
                    const newOpt = document.createElement('option');
                    newOpt.value = persona;
                    newOpt.textContent = persona;
                    personaFilter.appendChild(newOpt);
                }

                personaFilter.value = persona;
                updateTriggerFilterForPersona();
                renderMessagingList();
            }
        });

        // React to sequence toggle
        document.getElementById('view-sequence-toggle').addEventListener('change', renderMessagingList);

        // Handle expand / copy / edit / delete actions in messaging cards
        document.addEventListener('click', function (e) {
            const card = e.target.closest('.message-card');
            if (card) {
                const msgId = card.getAttribute('data-id');
                const msg = messagingLibrary.find(m => m.id === msgId);

                if (e.target.classList.contains('btn-copy-subject')) {
                    if (msg) copyToClipboard(msg.subject || '');
                    e.stopPropagation();
                    return;
                }

                if (e.target.classList.contains('btn-copy-body')) {
                    if (msg) copyToClipboard(msg.body || '');
                    e.stopPropagation();
                    return;
                }

                if (e.target.classList.contains('btn-edit-message')) {
                    e.stopPropagation();
                    showMessageModal(msgId);
                    return;
                }

                if (e.target.classList.contains('btn-delete-message')) {
                    e.stopPropagation();
                    if (confirm('Delete this messaging template? This cannot be undone.')) {
                        const idx = messagingLibrary.findIndex(m => m.id === msgId);
                        if (idx !== -1) {
                            messagingLibrary.splice(idx, 1);
                            saveMessagingToStorage();
                            buildMessagingFilters();
                            renderMessagingList();
                        }
                    }
                    return;
                }

                // Toggle expand on card click
                card.classList.toggle('expanded');
            }
        });

        function copyToClipboard(text) {
            if (!navigator.clipboard) {
                const temp = document.createElement('textarea');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
                alert('Copied to clipboard');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard');
            }).catch(() => {
                alert('Copy failed; please copy manually.');
            });
        }

        // Save all on page unload
        window.addEventListener('beforeunload', function () {
            saveCurrentTrigger();
            saveMessagingToStorage();
        });

        /***********************
         * INITIALIZE
         ***********************/
        function initializeAll() {
            // Discovery model
            const loadedDiscovery = loadDiscoveryFromStorage();
            if (!loadedDiscovery) {
                createSampleTriggers();
            } else {
                // Ensure structure & persona fields are present
                Object.values(triggers).forEach((t, idx) => {
                    if (!t.persona) t.persona = 'General';
                    if (!Array.isArray(t.sequence)) {
                        t.sequence = createEmptySequence();
                    }
                    t.sequence = t.sequence.map((item, i) => {
                        const template = discoverySequenceTemplate[i] || {};
                        return {
                            step: item.step || template.step || (i + 1),
                            title: item.title || template.title || "",
                            description: item.description || template.description || "",
                            coreQuestions: item.coreQuestions || item.questions || template.defaultQuestions || "",
                            examples: item.examples || template.examples || "",
                            notes: item.notes || "",
                            customQuestions: item.customQuestions || ""
                        };
                    });
                });

                const personas = getAllPersonas();
                currentPersona = personas[0] || null;
                const firstTrigger = Object.values(triggers).find(t => t.persona === currentPersona) || Object.values(triggers)[0];
                currentTriggerId = firstTrigger ? firstTrigger.id : null;
            }

            renderPersonaSelector();
            renderTriggerSelectorForPersona();

            // Messaging model
            const loadedMessaging = loadMessagingFromStorage();
            if (!loadedMessaging) {
                createSampleMessaging();
                saveMessagingToStorage();
            }

            buildMessagingFilters();
            renderMessagingList();
            populateTriggerSelectForMessageModal('any');
        }

        document.addEventListener('DOMContentLoaded', initializeAll);
    </script>
</body>
</html>
