<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Territory Potential Calculator - BearOps</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0A1628 0%, #1a2942 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .section-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .section-card:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .section-title {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-icon {
            font-size: 2rem;
        }

        .help-card {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 18px;
        }
        #serviceability-info {
            display: none;
        }
        #serviceability-info.open {
            display: block !important;
        }

        .scenario-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .scenario-btn {
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            text-align: center;
        }

        .scenario-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .scenario-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input, .input-group select {
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 1em;
            color: white;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .input-group small {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85em;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .kpi-label {
            font-size: 0.85em;
            color: #667eea;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .kpi-small {
            font-size: 1.6em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            overflow: hidden;
        }

        thead {
            background: rgba(102, 126, 234, 0.2);
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .total-row {
            background: rgba(102, 126, 234, 0.2) !important;
            font-weight: 700;
        }

        .total-row td {
            color: #667eea;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .help-text {
            background: rgba(72, 187, 120, 0.1);
            border-left: 4px solid #48bb78;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
        }

        .warning-box {
            background: rgba(241, 196, 15, 0.1);
            border-left: 4px solid #f39c12;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
        }

        .export-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .matrix-table input {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px;
            color: white;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .matrix-table input:focus {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            outline: none;
        }

        @media (max-width: 768px) {
            .header .logo {
                font-size: 2em;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .scenario-selector {
                grid-template-columns: 1fr;
            }

            .section-card {
                padding: 25px;
            }
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            padding-top: 30px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        .footer p {
            margin: 10px 0;
        }

        canvas {
            filter: brightness(1.1);
        }

        select option {
            background: #1a2942;
            color: white;
        }

        .framework-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .framework-item:hover {
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .framework-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .scenario-description {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
        }

        .lead-link-gradient {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .lead-link-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
    </style>
</head>
<body>
    <!-- Overlaid logo (doesn't change layout) -->
    <img src="../assets/images/BearOps_Logo_Default.png">

    <div class="container">
        <div class="header">
            <h1 class="tagline">Territory Potential Calculator</h1>
            <p class="subtitle">Model market opportunity, set targets, and optimize territory coverage</p>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <a href="../process/sales-playbook-hub/sales-playbook.html" class="lead-link-gradient">Back to Hub</a>
        </div>

        <!-- Global Settings -->
        <div class="section-card">
            <h2 class="section-title">
                <span class="section-icon">‚öôÔ∏è</span>
                Global Settings
            </h2>
            <div class="input-grid">
                <div class="input-group">
                    <label>Company / Project Name</label>
                    <input type="text" id="companyName" value="Your Company">
                </div>
                <div class="input-group">
                    <label>Currency Symbol</label>
                    <input type="text" id="currency" value="‚Ç¨" maxlength="3">
                </div>
                <div class="input-group">
                    <label>Global Market TAM (Annual)</label>
                    <input type="number" id="globalTAM" value="0" step="1000000">
                    <small>Section 2.1 ‚Äì total addressable market across all regions.</small>
                </div>
                <div class="input-group">
                    <label>Market Growth Rate (CAGR %)</label>
                    <input type="number" id="marketGrowth" value="10" step="1" min="0">
                    <small>Expected annual growth rate of the total market.</small>
                </div>
            </div>
        </div>

        <!-- Scenario Selector -->
        <div class="section-card">
            <h2 class="section-title">
                <span class="section-icon">üìä</span>
                Planning Scenario
            </h2>
            <div class="help-text">
                Select a planning scenario to automatically populate assumptions. Each scenario represents different market conditions and execution capabilities.
            </div>
            <div class="scenario-selector">
                <button class="scenario-btn" data-scenario="conservative">
                    <div>Conservative</div>
                    <div class="scenario-description">Cautious assumptions</div>
                </button>
                <button class="scenario-btn active" data-scenario="base">
                    <div>Base Case</div>
                    <div class="scenario-description">Realistic targets</div>
                </button>
                <button class="scenario-btn" data-scenario="stretch">
                    <div>Stretch Goals</div>
                    <div class="scenario-description">Aggressive targets</div>
                </button>
            </div>
        </div>

        <!-- Core Assumptions -->
        <div class="section-card">
            <h2 class="section-title">
                <span class="section-icon">üìà</span>
                Core Business Assumptions
            </h2>
            <div class="input-grid">
                <div class="input-group">
                    <label>Average Deal Size (Annual)</label>
                    <input type="number" id="asp" value="25000" step="1000">
                    <small>Expected annual revenue per acquired account (global default).</small>
                </div>
                <div class="input-group">
                    <label>Win Rate (%)</label>
                    <input type="number" id="winRate" value="22" step="1" min="0" max="100">
                    <small>Closed-won √∑ qualified opportunities</small>
                </div>
                <div class="input-group">
                    <label>Sales Cycle (months)</label>
                    <input type="number" id="salesCycle" value="3" step="0.5" min="0.5">
                    <small>Average time from lead to close</small>
                </div>
                <div class="input-group">
                    <label>Penetration in 12 Months (%)</label>
                    <input type="number" id="penetration" value="8" step="1" min="0" max="100">
                    <small>Share of SOM captured in first year</small>
                </div>
                <div class="input-group">
                    <label>Pipeline Coverage (x)</label>
                    <input type="number" id="pipelineCoverage" value="3.5" step="0.5" min="1">
                    <small>Pipeline √∑ bookings target multiplier</small>
                </div>
                <div class="input-group">
                    <label>Rep Annual Cost</label>
                    <input type="number" id="repCost" value="140000" step="5000">
                    <small>Salary + bonus + overhead</small>
                </div>
                <div class="input-group">
                    <label>Rep Annual Capacity (deals)</label>
                    <input type="number" id="repCapacity" value="14" step="1" min="1">
                    <small>New logos a rep can close per year</small>
                </div>
                <div class="input-group">
                    <label>Average TAM per Account</label>
                    <input type="number" id="tamPerAccount" value="200000" step="10000">
                    <small>Estimated annual spending per target account</small>
                </div>
            </div>
        </div>

        <!-- Territory & Segment Configuration -->
        <div class="section-card">
            <h2 class="section-title">
                <span class="section-icon">üó∫Ô∏è</span>
                Territory & Segment Configuration
            </h2>
            <div class="help-text">
                Define your territories and market segments, then specify target account counts and serviceability percentage for each combination.
            </div>
            <div class="help-card">
                <div onclick="document.getElementById('serviceability-info').classList.toggle('open')" 
                     style="cursor:pointer; display:flex; align-items:center; gap:8px;">
                    <span style="font-size:1.1rem;">‚ùì</span>
                    <span style="font-weight:600; color:#e2e8f0;">How is Serviceability % calculated?</span>
                </div>
                <div id="serviceability-info" style="margin-top:12px; color:#cbd5e1; font-size:0.85rem; line-height:1.45;">
                    <p><strong>Serviceability %</strong> is the share of accounts in a Territory √ó Segment that you can realistically work in the next 12‚Äì24 months.</p>
                    <p>It combines two factors:</p>
                    <ol style="margin-left:16px; margin-top:6px;">
                        <li><strong>Structural Fit</strong> ‚Äì language, product fit, regulatory barriers, ICP match.</li>
                        <li><strong>Practical Capacity</strong> ‚Äì reps √ó annual account capacity √∑ total accounts in that cell.</li>
                    </ol>
                    <p style="margin-top:8px;">Final Serviceability is typically set to <strong>the lower of structural fit &amp; practical capacity</strong>.</p>
                    <p style="margin-top:8px; font-size:0.83rem; color:#94a3b8;">
                        Example: 2 Enterprise AEs can work ~160 accounts/year in a 500-account universe ‚Üí serviceability ‚âà 32%, even if product fit is 90%.
                    </p>
                </div>
            </div>

            <div class="framework-item" style="margin-bottom: 24px;">
                <h4>Example: UK&amp;I Territory Definition</h4>
                <p style="font-size:0.9rem; color:rgba(226,232,240,0.9); margin-bottom:8px;">
                    This template can be used to model a concrete territory. For example:
                </p>
                <ul style="margin-left:18px; font-size:0.88rem; color:rgba(226,232,240,0.9); line-height:1.5;">
                    <li><strong>Territory:</strong> UK &amp; Ireland</li>
                    <li><strong>Segment 1 ‚Äì Mid-Market:</strong> 500 target accounts, covered by 4 AEs.<br>
                        With realistic rep capacity, you might set <strong>Serviceability ‚âà 95%</strong> for this cell.
                    </li>
                    <li><strong>Segment 2 ‚Äì Enterprise:</strong> 500 target accounts, covered by 2 AEs.<br>
                        Here capacity is the bottleneck, so you might set <strong>Serviceability ‚âà 35%</strong> even if product fit is high.
                    </li>
                </ul>
                <p style="font-size:0.85rem; color:#9ca3af; margin-top:6px;">
                    Together, these inputs translate your UK&amp;I TAM into SAM &amp; SOM, and flow into bookings,
                    pipeline, and rep planning in the dashboard below.
                </p>
            </div>

            <div class="input-grid" style="margin-bottom: 30px;">
                <div class="input-group">
                    <label>Number of Territories</label>
                    <select id="territoryCount">
                        <option value="2">2 Territories</option>
                        <option value="3" selected>3 Territories</option>
                        <option value="4">4 Territories</option>
                        <option value="5">5 Territories</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Number of Segments</label>
                    <select id="segmentCount">
                        <option value="2">2 Segments</option>
                        <option value="3" selected>3 Segments</option>
                        <option value="4">4 Segments</option>
                        <option value="5">5 Segments</option>
                    </select>
                </div>
            </div>

            <div id="territorySegmentMatrix"></div>
        </div>

        <!-- Dashboard KPIs -->
        <div class="section-card">
            <h2 class="section-title">
                <span class="section-icon">üìä</span>
                Performance Dashboard (12 Month Projection)
            </h2>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Global Market TAM (2.1)</div>
                    <div class="kpi-value" id="globalTAMDisplay">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total TAM</div>
                    <div class="kpi-value" id="totalTAM">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total SAM</div>
                    <div class="kpi-value" id="totalSAM">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total SOM</div>
                    <div class="kpi-value" id="totalSOM">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">TAM Coverage vs Global</div>
                    <div class="kpi-value kpi-small" id="tamCoverageDisplay">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Projected TAM in 3 Years</div>
                    <div class="kpi-value" id="tam3YearDisplay">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Target Bookings</div>
                    <div class="kpi-value" id="totalBookings">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Required Pipeline</div>
                    <div class="kpi-value" id="requiredPipeline">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Recommended Reps</div>
                    <div class="kpi-value kpi-small" id="recommendedReps">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Cost per ‚Ç¨ Booked</div>
                    <div class="kpi-value kpi-small" id="costPerBooked">‚Ç¨0.00</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Deals Needed</div>
                    <div class="kpi-value kpi-small" id="totalDeals">0</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="funnelChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="territoryChart"></canvas>
            </div>
        </div>

        <!-- Territory Breakdown -->
        <div class="section-card">
            <h2 class="section-title">
                <span class="section-icon">üìã</span>
                Territory & Segment Breakdown
            </h2>
            <div style="overflow-x: auto;">
                <table id="breakdownTable">
                    <thead>
                        <tr>
                            <th>Territory</th>
                            <th>Segment</th>
                            <th>Target Accounts</th>
                            <th>TAM</th>
                            <th>SAM</th>
                            <th>SOM</th>
                            <th>Bookings (12m)</th>
                            <th>Pipeline Needed</th>
                        </tr>
                    </thead>
                    <tbody id="breakdownBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rep Planning -->
        <div class="section-card">
            <h2 class="section-title">
                <span class="section-icon">üë•</span>
                Rep Planning & Productivity Analysis
            </h2>
            <div style="overflow-x: auto;">
                <table id="repTable">
                    <thead>
                        <tr>
                            <th>Territory</th>
                            <th>Target Bookings</th>
                            <th>Deals Needed</th>
                            <th>Reps Required</th>
                            <th>Total Cost</th>
                            <th>Productivity</th>
                        </tr>
                    </thead>
                    <tbody id="repBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Options -->
        <div class="section-card">
            <h2 class="section-title">
                <span class="section-icon">üíæ</span>
                Export & Save
            </h2>
            <div class="export-section">
                <button class="export-btn" onclick="exportToCSV()">üìä Export to CSV</button>
                <button class="export-btn" onclick="saveToLocalStorage()">üíæ Save Configuration</button>
                <button class="export-btn" onclick="loadFromLocalStorage()">üìÇ Load Configuration</button>
                <button class="export-btn" onclick="printReport()">üñ®Ô∏è Print Report</button>
            </div>
        </div>

        <div class="footer">
            <p>Territory Potential Calculator ‚Ä¢ BearOps Sales Operations Framework</p>
            <p>Designed for Series A-Funded Startups Building Scalable Revenue Systems</p>
        </div>
    </div>

    <script>
        // Scenario definitions
        const scenarios = {
            conservative: {
                asp: 15000,
                winRate: 15,
                salesCycle: 4,
                penetration: 5,
                pipelineCoverage: 3,
                repCost: 120000,
                repCapacity: 10
            },
            base: {
                asp: 25000,
                winRate: 22,
                salesCycle: 3,
                penetration: 8,
                pipelineCoverage: 3.5,
                repCost: 140000,
                repCapacity: 14
            },
            stretch: {
                asp: 40000,
                winRate: 30,
                salesCycle: 2,
                penetration: 12,
                pipelineCoverage: 4,
                repCost: 160000,
                repCapacity: 18
            }
        };

        // Default territory and segment data
        let territoryData = [
            { name: 'UK & Ireland', accounts: [] },
            { name: 'Central Region', accounts: [] },
            { name: 'South Region', accounts: [] }
        ];

        // Pre-populate first two segments as UK&I Mid-Market and UK&I Enterprise
        let segmentData = [
            { name: 'UK&I Mid-Market', description: '500 target accounts, 4 AEs' },
            { name: 'UK&I Enterprise', description: '500 target accounts, 2 AEs' },
            { name: 'SMB / Other', description: '<100 employees or long-tail ICP' }
        ];

        // Matrix data structure
        let matrixData = [];

        // Initialize matrix with default data
        function initializeMatrix() {
            const territoryCount = parseInt(document.getElementById('territoryCount').value);
            const segmentCount = parseInt(document.getElementById('segmentCount').value);

            while (territoryData.length < territoryCount) {
                territoryData.push({ name: `Territory ${territoryData.length + 1}`, accounts: [] });
            }
            while (segmentData.length < segmentCount) {
                segmentData.push({ 
                    name: `Segment ${segmentData.length + 1}`, 
                    description: '', 
                    tier: 'Tier 3', 
                    asp: 0 
                });
            }

            matrixData = [];
            for (let t = 0; t < territoryCount; t++) {
                matrixData[t] = [];
                for (let s = 0; s < segmentCount; s++) {
                    let defaultAccounts;
                    let defaultServiceability;

                    // UK&I example pre-populated for first territory
                    if (t === 0 && s === 0) {
                        // UK&I Mid-Market
                        defaultAccounts = 500;
                        defaultServiceability = 95;
                    } else if (t === 0 && s === 1) {
                        // UK&I Enterprise
                        defaultAccounts = 500;
                        defaultServiceability = 35;
                    } else {
                        // Generic defaults for all other cells
                        defaultAccounts = 50;
                        defaultServiceability = 70;
                    }
                    
                    matrixData[t][s] = {
                        accounts: defaultAccounts,
                        serviceability: defaultServiceability
                    };
                }
            }
        }

        // Render the territory/segment matrix
        function renderMatrix() {
            const container = document.getElementById('territorySegmentMatrix');
            const territoryCount = parseInt(document.getElementById('territoryCount').value);
            const segmentCount = parseInt(document.getElementById('segmentCount').value);

            let html = '<h3 style="margin-bottom: 20px; color: #667eea; font-size: 1.2rem;">Territory &amp; Segment Names</h3>';
            html += '<div class="input-grid" style="margin-bottom: 35px;">';
            
            // Territories
            for (let t = 0; t < territoryCount; t++) {
                html += `
                    <div class="input-group">
                        <label>Territory ${t + 1} Name</label>
                        <input type="text" id="territory_${t}" value="${territoryData[t].name}" 
                               onchange="territoryData[${t}].name = this.value; calculate();">
                    </div>
                `;
            }

            // Segments
            for (let s = 0; s < segmentCount; s++) {
                html += `
                    <div class="input-group">
                        <label>Segment ${s + 1} Name</label>
                        <input type="text" id="segment_${s}" value="${segmentData[s].name}" 
                               onchange="segmentData[${s}].name = this.value; calculate();">
                        <small>Describe ICP here (e.g. Enterprise SaaS, 1000+ FTEs).</small>
                    </div>
                `;
            }

            html += '</div>';

            html += '<h3 style="margin-bottom: 20px; color: #667eea; font-size: 1.2rem;">Target Accounts &amp; Serviceability by Territory √ó Segment</h3>';
            html += '<div style="overflow-x: auto;"><table class="matrix-table" style="margin-bottom: 0;"><thead><tr>';
            html += '<th>Territory</th><th>Segment</th><th>Target Accounts</th><th>Serviceability %</th>';
            html += '</tr></thead><tbody>';

            for (let t = 0; t < territoryCount; t++) {
                for (let s = 0; s < segmentCount; s++) {
                    const data = matrixData[t][s];
                    html += `
                        <tr>
                            <td><strong>${territoryData[t].name}</strong></td>
                            <td>${segmentData[s].name}</td>
                            <td>
                                <input type="number" value="${data.accounts}" 
                                       onchange="matrixData[${t}][${s}].accounts = parseInt(this.value) || 0; calculate();"
                                       style="width: 130px;">
                            </td>
                            <td>
                                <input type="number" value="${data.serviceability}" min="0" max="100" step="1"
                                       onchange="matrixData[${t}][${s}].serviceability = parseInt(this.value) || 0; calculate();"
                                       style="width: 110px;">
                            </td>
                        </tr>
                    `;
                }
            }

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Scenario selection
        document.querySelectorAll('.scenario-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const scenario = this.dataset.scenario;
                const values = scenarios[scenario];
                
                document.getElementById('asp').value = values.asp;
                document.getElementById('winRate').value = values.winRate;
                document.getElementById('salesCycle').value = values.salesCycle;
                document.getElementById('penetration').value = values.penetration;
                document.getElementById('pipelineCoverage').value = values.pipelineCoverage;
                document.getElementById('repCost').value = values.repCost;
                document.getElementById('repCapacity').value = values.repCapacity;
                
                calculate();
            });
        });

        // Add event listeners to all inputs
        ['companyName', 'currency', 'asp', 'winRate', 'salesCycle', 'penetration', 
         'pipelineCoverage', 'repCost', 'repCapacity', 'tamPerAccount', 'globalTAM', 'marketGrowth'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculate);
        });

        document.getElementById('territoryCount').addEventListener('change', function() {
            initializeMatrix();
            renderMatrix();
            calculate();
        });

        document.getElementById('segmentCount').addEventListener('change', function() {
            initializeMatrix();
            renderMatrix();
            calculate();
        });

        // Main calculation function
        function calculate() {
            const currency = document.getElementById('currency').value;
            const asp = parseFloat(document.getElementById('asp').value) || 0;
            const winRate = parseFloat(document.getElementById('winRate').value) / 100 || 0;
            const salesCycle = parseFloat(document.getElementById('salesCycle').value) || 1;
            const penetration = parseFloat(document.getElementById('penetration').value) / 100 || 0;
            const pipelineCoverage = parseFloat(document.getElementById('pipelineCoverage').value) || 1;
            const repCost = parseFloat(document.getElementById('repCost').value) || 0;
            const repCapacity = parseFloat(document.getElementById('repCapacity').value) || 1;
            const tamPerAccount = parseFloat(document.getElementById('tamPerAccount').value) || 0;

            const globalTAM = parseFloat(document.getElementById('globalTAM').value) || 0;
            const marketGrowth = parseFloat(document.getElementById('marketGrowth').value) / 100 || 0;

            const territoryCount = parseInt(document.getElementById('territoryCount').value);
            const segmentCount = parseInt(document.getElementById('segmentCount').value);

            let totalTAM = 0, totalSAM = 0, totalSOM = 0, totalBookings = 0;
            let totalDeals = 0;
            let results = [];

            for (let t = 0; t < territoryCount; t++) {
                for (let s = 0; s < segmentCount; s++) {
                    const data = matrixData[t][s];
                    const accounts = data.accounts;
                    const serviceability = data.serviceability / 100;

                    const tam = accounts * tamPerAccount;
                    const sam = tam * serviceability;
                    const som = sam;
                    const bookings = som * penetration;
                    const deals = asp > 0 ? (bookings / asp) : 0;

                    totalTAM += tam;
                    totalSAM += sam;
                    totalSOM += som;
                    totalBookings += bookings;
                    totalDeals += deals;

                    results.push({
                        territory: territoryData[t].name,
                        segment: segmentData[s].name,
                        accounts,
                        tam,
                        sam,
                        som,
                        bookings,
                        pipeline: bookings * pipelineCoverage
                    });
                }
            }

            const totalPipeline = totalBookings * pipelineCoverage;
            const totalDealsRounded = Math.ceil(totalDeals);
            const recommendedReps = repCapacity > 0 ? Math.ceil(totalDealsRounded / repCapacity) : 0;
            const totalRepCost = recommendedReps * repCost;
            const costPerBooked = totalBookings > 0 ? totalRepCost / totalBookings : 0;

            const tamCoverage = globalTAM > 0 ? (totalTAM / globalTAM) : 0;
            const tam3Year = globalTAM > 0 ? globalTAM * Math.pow(1 + marketGrowth, 3) : 0;

            document.getElementById('globalTAMDisplay').textContent = formatCurrency(globalTAM, currency);
            document.getElementById('totalTAM').textContent = formatCurrency(totalTAM, currency);
            document.getElementById('totalSAM').textContent = formatCurrency(totalSAM, currency);
            document.getElementById('totalSOM').textContent = formatCurrency(totalSOM, currency);
            document.getElementById('totalBookings').textContent = formatCurrency(totalBookings, currency);
            document.getElementById('requiredPipeline').textContent = formatCurrency(totalPipeline, currency);
            document.getElementById('recommendedReps').textContent = recommendedReps;
            document.getElementById('costPerBooked').textContent = currency + costPerBooked.toFixed(2);
            document.getElementById('totalDeals').textContent = totalDealsRounded;
            document.getElementById('tamCoverageDisplay').textContent = (tamCoverage > 0 ? (tamCoverage * 100).toFixed(1) : 0) + '%';
            document.getElementById('tam3YearDisplay').textContent = formatCurrency(tam3Year, currency);

            updateBreakdownTable(results, currency);
            updateRepTable(territoryCount, repCapacity, repCost, currency);
            updateCharts(totalTAM, totalSAM, totalSOM, totalBookings, totalPipeline, currency);
        }

        function updateBreakdownTable(results, currency) {
            const tbody = document.getElementById('breakdownBody');
            let html = '';

            results.forEach(r => {
                html += `
                    <tr>
                        <td><strong>${r.territory}</strong></td>
                        <td>${r.segment}</td>
                        <td>${r.accounts.toLocaleString()}</td>
                        <td>${formatCurrency(r.tam, currency)}</td>
                        <td>${formatCurrency(r.sam, currency)}</td>
                        <td>${formatCurrency(r.som, currency)}</td>
                        <td>${formatCurrency(r.bookings, currency)}</td>
                        <td>${formatCurrency(r.pipeline, currency)}</td>
                    </tr>
                `;
            });

            const totals = results.reduce((acc, r) => {
                acc.accounts += r.accounts;
                acc.tam += r.tam;
                acc.sam += r.sam;
                acc.som += r.som;
                acc.bookings += r.bookings;
                acc.pipeline += r.pipeline;
                return acc;
            }, { accounts: 0, tam: 0, sam: 0, som: 0, bookings: 0, pipeline: 0 });

            html += `
                <tr class="total-row">
                    <td colspan="2"><strong>TOTAL</strong></td>
                    <td><strong>${totals.accounts.toLocaleString()}</strong></td>
                    <td><strong>${formatCurrency(totals.tam, currency)}</strong></td>
                    <td><strong>${formatCurrency(totals.sam, currency)}</strong></td>
                    <td><strong>${formatCurrency(totals.som, currency)}</strong></td>
                    <td><strong>${formatCurrency(totals.bookings, currency)}</strong></td>
                    <td><strong>${formatCurrency(totals.pipeline, currency)}</strong></td>
                </tr>
            `;

            tbody.innerHTML = html;
        }

        function updateRepTable(territoryCount, repCapacity, repCost, currency) {
            const tbody = document.getElementById('repBody');
            const aspGlobal = parseFloat(document.getElementById('asp').value) || 0;
            let html = '';

            const territoryBookings = new Array(territoryCount).fill(0);
            const segmentCount = parseInt(document.getElementById('segmentCount').value);

            let totalReps = 0;
            let totalCost = 0;
            let totalDeals = 0;

            for (let t = 0; t < territoryCount; t++) {
                let territoryDeals = 0;

                for (let s = 0; s < segmentCount; s++) {
                    const data = matrixData[t][s];
                    const accounts = data.accounts;
                    const serviceability = data.serviceability / 100;
                    const tamPerAccount = parseFloat(document.getElementById('tamPerAccount').value) || 0;
                    const penetration = parseFloat(document.getElementById('penetration').value) / 100 || 0;

                    const tam = accounts * tamPerAccount;
                    const sam = tam * serviceability;
                    const som = sam;
                    const bookings_val = som * penetration;
                    const deals_val = aspGlobal > 0 ? (bookings_val / aspGlobal) : 0;

                    territoryBookings[t] += bookings_val;
                    territoryDeals += deals_val;
                }

                const bookings = territoryBookings[t];
                const deals = Math.ceil(territoryDeals);
                const reps = repCapacity > 0 ? Math.ceil(deals / repCapacity) : 0;
                const cost = reps * repCost;
                const productivity = reps > 0 ? (bookings / reps) : 0;

                totalReps += reps;
                totalCost += cost;
                totalDeals += deals;

                html += `
                    <tr>
                        <td><strong>${territoryData[t].name}</strong></td>
                        <td>${formatCurrency(bookings, currency)}</td>
                        <td>${deals}</td>
                        <td>${reps}</td>
                        <td>${formatCurrency(cost, currency)}</td>
                        <td>${formatCurrency(productivity, currency)}/rep</td>
                    </tr>
                `;
            }

            const totalBookings = territoryBookings.reduce((a, b) => a + b, 0);
            const avgProductivity = totalReps > 0 ? (totalBookings / totalReps) : 0;

            html += `
                <tr class="total-row">
                    <td><strong>TOTAL</strong></td>
                    <td><strong>${formatCurrency(totalBookings, currency)}</strong></td>
                    <td><strong>${totalDeals}</strong></td>
                    <td><strong>${totalReps}</strong></td>
                    <td><strong>${formatCurrency(totalCost, currency)}</strong></td>
                    <td><strong>${formatCurrency(avgProductivity, currency)}/rep</strong></td>
                </tr>
            `;

            tbody.innerHTML = html;
        }

        let funnelChart, territoryChart;

        function updateCharts(tam, sam, som, bookings, pipeline, currency) {
            const funnelCtx = document.getElementById('funnelChart');
            if (funnelChart) {
                funnelChart.destroy();
            }

            funnelChart = new Chart(funnelCtx, {
                type: 'bar',
                data: {
                    labels: ['TAM', 'SAM', 'SOM', 'Pipeline', 'Bookings'],
                    datasets: [{
                        label: 'Market Funnel (' + currency + ')',
                        data: [tam, sam, som, pipeline, bookings],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(237, 100, 166, 0.8)',
                            'rgba(255, 154, 158, 0.8)',
                            'rgba(72, 187, 120, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(118, 75, 162, 1)',
                            'rgba(237, 100, 166, 1)',
                            'rgba(255, 154, 158, 1)',
                            'rgba(72, 187, 120, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Market Opportunity Funnel',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#667eea'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return currency + context.parsed.x.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return currency + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            const territoryCtx = document.getElementById('territoryChart');
            if (territoryChart) {
                territoryChart.destroy();
            }

            const territoryCount = parseInt(document.getElementById('territoryCount').value);
            const segmentCount = parseInt(document.getElementById('segmentCount').value);
            const territoryLabels = [];
            const territoryValues = [];

            for (let t = 0; t < territoryCount; t++) {
                let territoryBookings = 0;
                for (let s = 0; s < segmentCount; s++) {
                    const data = matrixData[t][s];
                    const accounts = data.accounts;
                    const serviceability = data.serviceability / 100;
                    const tamPerAccount = parseFloat(document.getElementById('tamPerAccount').value) || 0;
                    const penetration = parseFloat(document.getElementById('penetration').value) / 100 || 0;

                    const tam_val = accounts * tamPerAccount;
                    const sam_val = tam_val * serviceability;
                    const som_val = sam_val;
                    const bookings_val = som_val * penetration;

                    territoryBookings += bookings_val;
                }
                territoryLabels.push(territoryData[t].name);
                territoryValues.push(territoryBookings);
            }

            territoryChart = new Chart(territoryCtx, {
                type: 'doughnut',
                data: {
                    labels: territoryLabels,
                    datasets: [{
                        label: 'Bookings by Territory',
                        data: territoryValues,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(237, 100, 166, 0.8)',
                            'rgba(255, 154, 158, 0.8)',
                            'rgba(72, 187, 120, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(118, 75, 162, 1)',
                            'rgba(237, 100, 166, 1)',
                            'rgba(255, 154, 158, 1)',
                            'rgba(72, 187, 120, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Target Bookings by Territory',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#667eea'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': ' + currency + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function formatCurrency(value, symbol) {
            if (value >= 1000000) {
                return symbol + (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return symbol + (value / 1000).toFixed(1) + 'K';
            } else {
                return symbol + value.toFixed(0);
            }
        }

        function exportToCSV() {
            const currency = document.getElementById('currency').value;
            const company = document.getElementById('companyName').value;
            
            let csv = 'Territory Potential Calculator - Export\n';
            csv += 'Company: ' + company + '\n\n';
            
            csv += 'Summary Metrics\n';
            csv += 'Metric,Value\n';
            csv += 'Global Market TAM,' + document.getElementById('globalTAMDisplay').textContent + '\n';
            csv += 'Total TAM,' + document.getElementById('totalTAM').textContent + '\n';
            csv += 'Total SAM,' + document.getElementById('totalSAM').textContent + '\n';
            csv += 'Total SOM,' + document.getElementById('totalSOM').textContent + '\n';
            csv += 'Target Bookings,' + document.getElementById('totalBookings').textContent + '\n';
            csv += 'Required Pipeline,' + document.getElementById('requiredPipeline').textContent + '\n';
            csv += 'Recommended Reps,' + document.getElementById('recommendedReps').textContent + '\n';
            csv += '\n';
            
            csv += 'Territory & Segment Breakdown\n';
            csv += 'Territory,Segment,Target Accounts,TAM,SAM,SOM,Bookings,Pipeline\n';
            
            const table = document.getElementById('breakdownTable');
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const rowData = Array.from(cells).map(cell => cell.textContent.trim());
                    csv += rowData.join(',') + '\n';
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'territory_calculator_export.csv';
            a.click();
        }

        function saveToLocalStorage() {
            const config = {
                companyName: document.getElementById('companyName').value,
                currency: document.getElementById('currency').value,
                asp: document.getElementById('asp').value,
                winRate: document.getElementById('winRate').value,
                salesCycle: document.getElementById('salesCycle').value,
                penetration: document.getElementById('penetration').value,
                pipelineCoverage: document.getElementById('pipelineCoverage').value,
                repCost: document.getElementById('repCost').value,
                repCapacity: document.getElementById('repCapacity').value,
                tamPerAccount: document.getElementById('tamPerAccount').value,
                globalTAM: document.getElementById('globalTAM').value,
                marketGrowth: document.getElementById('marketGrowth').value,
                territoryCount: document.getElementById('territoryCount').value,
                segmentCount: document.getElementById('segmentCount').value,
                territoryData: territoryData,
                segmentData: segmentData,
                matrixData: matrixData
            };
            
            localStorage.setItem('territoryCalculator', JSON.stringify(config));
            alert('Configuration saved successfully!');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('territoryCalculator');
            if (!saved) {
                alert('No saved configuration found.');
                return;
            }
            
            const config = JSON.parse(saved);
            
            document.getElementById('companyName').value = config.companyName;
            document.getElementById('currency').value = config.currency;
            document.getElementById('asp').value = config.asp;
            document.getElementById('winRate').value = config.winRate;
            document.getElementById('salesCycle').value = config.salesCycle;
            document.getElementById('penetration').value = config.penetration;
            document.getElementById('pipelineCoverage').value = config.pipelineCoverage;
            document.getElementById('repCost').value = config.repCost;
            document.getElementById('repCapacity').value = config.repCapacity;
            document.getElementById('tamPerAccount').value = config.tamPerAccount;
            document.getElementById('globalTAM').value = config.globalTAM || 0;
            document.getElementById('marketGrowth').value = config.marketGrowth || 10;
            document.getElementById('territoryCount').value = config.territoryCount;
            document.getElementById('segmentCount').value = config.segmentCount;
            
            territoryData = config.territoryData;
            segmentData = config.segmentData;
            matrixData = config.matrixData;
            
            renderMatrix();
            calculate();
            
            alert('Configuration loaded successfully!');
        }

        function printReport() {
            window.print();
        }

        // Initialize on page load
        initializeMatrix();
        renderMatrix();
        calculate();
    </script>
</body>
</html>
